<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Gift Roulette ‚Äî TMA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css?family=Russo+One|Montserrat:700,600,400&display=swap" rel="stylesheet">
  <style>
    html,body {
      background: linear-gradient(120deg, #181e24 0%, #23272f 100%);
      min-height: 100vh;
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0; padding: 0;
      color: #fff;
      font-size: 17px;
    }
    #app { min-height: 100vh; }
    .splash {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100vh; width: 100vw; position: fixed; z-index: 99; top:0; left:0; background: #181e24;
      animation: fadein .85s cubic-bezier(.2,.75,.23,1);
    }
    .splash-logo { font-size: 3.1rem; margin-bottom: 12px; animation: tada .9s .2s;}
    .splash-title { font-family: 'Russo One'; font-size: 2.1rem; margin-bottom: 7px; letter-spacing: .05em; }
    .splash-desc { color: #ffe47a; font-size: 1.09rem; margin-bottom: 29px;}
    .splash-btn {
      background: linear-gradient(90deg, #ffe47a, #ffc03e 70%, #ffe47a); color: #181e24; font-weight: 700;
      font-size: 1.23rem; padding: 13px 42px; border-radius: 22px; border: none; box-shadow: 0 2px 12px #0005;
      cursor: pointer; transition: .12s; font-family: 'Russo One'; letter-spacing: .08em;}
    .splash-btn:active { background: #ffe7ac;}
    .tabbar {
      position: fixed; left: 0; bottom: 0; width: 100vw; z-index: 22; background: #1e232b;
      display: flex; justify-content: space-around; border-top: 2px solid #272c37;
      box-shadow: 0 -2px 14px #0005;
    }
    .tab-btn {
      flex: 1; display: flex; flex-direction: column; align-items: center; padding: 11px 0 5px 0;
      color: #bbb; font-size: 1.07rem; font-weight: 600; letter-spacing: .02em; cursor: pointer;
      outline: none; border: none; background: none; transition: color .14s;
      font-family: 'Montserrat'; user-select: none; min-width: 70px;
    }
    .tab-btn.active { color: #ffd700;}
    .tab-btn-ic { font-size: 2.08em; line-height: 1;}
    .main-section { display: none; padding-bottom: 64px;}
    .main-section.active { display: block; animation: fadein .5s;}
    .container { max-width: 420px; margin: 22px auto 0 auto; background: #212633; border-radius: 20px;
      box-shadow: 0 6px 28px #000a; padding: 28px 12px 12px 12px; text-align: center;}
    .profile { display: flex; align-items: center; margin-bottom: 18px; gap: 16px; justify-content: center;}
    .profile-img { width: 66px; height: 66px; border-radius: 50%; object-fit: cover; border: 2.5px solid #ffe48a; background: #191c22;}
    .profile-info { text-align: left; font-size: 1.13rem; max-width: 220px; overflow: hidden; text-overflow: ellipsis;}
    .profile-info .uname { color: #ffe79c; font-family: 'Russo One', Arial, sans-serif; font-size: 1.26rem; margin-bottom: 3px; display: block;}
    .profile-id { font-size: .97em; color: #aaa; }
    .profile-edit-btn { margin-top: 8px; background: #282f39; border: none; border-radius: 11px; padding: 7px 18px; color: #ffd700; font-weight: 600; cursor:pointer;}
    .profile-edit-btn:active { background: #22262d;}
    .title { font-family: 'Russo One', Arial, sans-serif; font-size: 2.22rem; letter-spacing: 1.5px; margin-bottom: 6px;
      background: linear-gradient(90deg, #e4c05c, #ffefb0 60%, #b0a871); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block;}
    .roulette-block { padding-bottom: 22px;}
    .roulette { background: #181d22; border: 2px solid #2f3642; border-radius: 26px;
      box-shadow: 0 4px 18px #0006 inset; margin: 18px 0 13px 0; padding: 30px 0 18px 0;
      position: relative; overflow: hidden; min-height: 134px; user-select: none; }
    .roulette-list { display: flex; will-change: transform; align-items: center; }
    .item {
      min-width: 108px; max-width: 108px; height: 108px; margin: 0 7px; background: #242d3a;
      border-radius: 19px; box-shadow: 0 3px 14px #0009; display: flex; flex-direction: column; justify-content: center; align-items: center;
      border: 2.5px solid #222b; font-size: 2.2rem; transition: border .12s, box-shadow .14s, transform .12s; position: relative;}
    .item.selected, .item.win { border-color: #ffd700; box-shadow: 0 0 22px 4px #ffd70088, 0 3px 13px #000a; z-index: 2; animation: giftbounce .82s cubic-bezier(.23,1.2,.23,1);}
    .item .gift-emoji { font-size: 2.8em; animation: emojiBounce 1.8s infinite alternate cubic-bezier(.4,.9,.36,1);}
    .item .gift-name { font-size: 1.07rem; color: #f4d58b; margin-top: 10px; letter-spacing: .03em;}
    .marker { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 2; width: 0; height: 0;
      border-left: 17px solid transparent; border-right: 17px solid transparent; border-bottom: 23px solid #f5cb4e;
      filter: drop-shadow(0 2px 7px #222a);}
    .spin-btn { margin-top: 25px; width: 88%; padding: 19px; border-radius: 22px; background: linear-gradient(90deg, #f5cb4e, #f9e67c 70%, #f5cb4e);
      color: #191f26; font-family: 'Russo One', Arial, sans-serif; font-size: 1.45rem; letter-spacing: .08em; border: none; outline: none;
      box-shadow: 0 3px 16px #0006; cursor: pointer; font-weight: 800; transition: background .13s, transform .13s; margin-bottom: 2px;}
    .spin-btn:active, .spin-btn:focus { background: #ffe18c; transform: scale(.98);}
    .spin-btn:disabled { background: #ffe18c; opacity: .72; cursor: not-allowed;}
    .msg { background: #262c36; border-radius: 12px; margin: 18px 0 13px 0; padding: 18px 12px 18px 12px; font-size: 1.15rem;
      box-shadow: 0 2px 8px #0004 inset; line-height: 1.58; min-height: 70px; display: none;}
    .msg.visible { display: block; animation: fadein .38s;}
    .confirm-btn {
      background: #4dbe2a; color: #fff; padding: 15px 46px; border-radius: 15px; font-size: 1.15rem; font-weight: 700; margin-top: 18px;
      border: none; cursor: pointer; transition: background .12s, transform .11s; display: none;}
    .confirm-btn:active { background: #278030;}
    .confirm-btn.visible { display: inline-block; }
    .wait-status { margin-top: 18px; color: #eee; font-size: 1.11em; }
    .wait-dot { display: inline-block; animation: blink 1.1s infinite;}
    .modal-bg {
      display:none; position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:222;background:#141821bb;
      align-items:center;justify-content:center;}
    .modal-bg.active { display:flex; animation: fadein .22s;}
    .modal {
      background: #23283b; border-radius: 22px; box-shadow: 0 4px 40px #000d;
      padding: 32px 26px 27px 26px; max-width: 340px; width:92vw; text-align: center; color: #fff; position:relative;
      animation: modalpop .22s cubic-bezier(.2,1.2,.23,1);}
    .modal .big-emoji { font-size: 4.5em; margin-bottom: 14px; animation: tada .7s;}
    .modal-title { font-size: 1.44em; font-family:'Russo One'; color:#ffe37a; margin-bottom:8px;}
    .modal-btn { background: linear-gradient(90deg, #ffe47a, #ffc03e 70%, #ffe47a); color: #181e24; font-weight: 700; font-size: 1.17rem;
      padding: 11px 39px; border-radius: 15px; border: none; cursor: pointer; margin-top: 24px;}
    .modal-btn:active { background: #ffe7ac;}
    .snackbar { visibility: hidden; min-width: 180px; background: #242d3a; color: #fff; text-align: center; border-radius: 11px; padding: 13px 22px;
      position: fixed; z-index: 299; left: 50%; bottom: 40px; transform: translateX(-50%); font-size: 1.08rem; box-shadow: 0 2px 14px #0007;
      transition: visibility 0s, opacity .35s cubic-bezier(.4,.01,0,1), bottom .23s; opacity: 0; pointer-events: none;}
    .snackbar.show { visibility: visible; opacity: 1; pointer-events: auto; bottom: 65px;}
    .history {
      background: #242d3a; border-radius: 13px; margin: 24px 0 0 0; padding: 18px 10px 14px 10px; text-align: left; font-size: 1.01rem;
      color: #ccc; min-height: 48px;}
    .history h4 { margin: 0 0 12px 0; color: #e8c067; font-size: 1.16rem;}
    .history-cards { display: flex; flex-direction: column; gap: 13px;}
    .history-card { background: #23293b; border-radius: 13px; padding: 14px 10px 14px 15px; display: flex; align-items: center; gap: 19px;
      box-shadow: 0 2px 12px #0004;}
    .history-gift { font-size: 2.3em;}
    .history-info { flex:1; }
    .history-name { font-size: 1.09em; color: #ffe79c; font-weight: 600; margin-bottom: 4px;}
    .history-time { font-size: .99em; color: #aaa;}
    .history-status { font-size: 1em; color: #81e278; font-weight: 700; }
    .history-status.wait { color: #ffd864;}
    .filterbar { margin: 0 0 10px 0; display: flex; gap: 9px;}
    .filter-btn { background: #262c36; border: none; color: #ffe47a; font-weight: 700; font-size: .97em; border-radius: 9px; padding: 7px 14px; cursor: pointer; }
    .filter-btn.active { background: #ffd700; color: #222; }
    .confetti { position: fixed; pointer-events: none; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 199; overflow: hidden; }
    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 7px;}
    ::-webkit-scrollbar-thumb { background: #23293b; border-radius: 4px;}
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadein { from { opacity: 0;} to { opacity: 1;} }
    @keyframes tada {
      0% { transform: scale(1);}
      10%,20% { transform: scale(0.95) rotate(-6deg);}
      30%,50%,70%,90% { transform: scale(1.07) rotate(6deg);}
      40%,60%,80% { transform: scale(1.08) rotate(-6deg);}
      100% { transform: scale(1);}
    }
    @keyframes blink { 0%, 100% {opacity:1;} 40% {opacity:0.5;} }
    @keyframes modalpop { from {transform: scale(.8); opacity:0;} to {transform: scale(1); opacity:1;} }
    @keyframes emojiBounce { 0% {transform: scale(1);} 85% {transform: scale(1.14);} 100% {transform: scale(1);} }
    @keyframes giftbounce { 0% {transform: scale(1.14);} 85% {transform: scale(.97);} 100% {transform: scale(1);} }
    @media (max-width: 600px) {
      .container {max-width:98vw;}
      .item, .roulette {min-width:80px;}
      .item {min-width:72px;max-width:72px;height:72px;}
    }
    @media (max-width: 480px) {
      .tab-btn { font-size: 0.97rem; min-width: 54px;}
      .container { padding: 10px 0 0 0;}
      .profile-img { width:42px;height:42px;}
    }
  </style>
</head>
<body>
<div id="app">
  <!-- SPLASH -->
  <div class="splash" id="splashScreen">
    <div class="splash-logo">üé∞</div>
    <div class="splash-title">Gift Roulette</div>
    <div class="splash-desc">–†–∞–∑—ã–≥—Ä–∞–π –ø–æ–¥–∞—Ä–∫–∏, –≤—ã–∏–≥—Ä—ã–≤–∞–π ‚Äî –ø—Ä–æ—Å—Ç–æ, —á–µ—Å—Ç–Ω–æ, –≤–µ—Å–µ–ª–æ!<br>–í—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ ‚Äî –±—ã—Ç—å –≤ Telegram üòâ</div>
    <button class="splash-btn" id="splashStartBtn">–ù–∞—á–∞—Ç—å</button>
  </div>
  <!-- MAIN -->
  <div class="main-section" id="rouletteSection">
    <div class="container roulette-block">
      <div class="title">Gift Roulette</div>
      <div class="roulette" id="roulette">
        <div class="marker"></div>
        <div class="roulette-list" id="rouletteList"></div>
      </div>
      <button class="spin-btn" id="spinBtn">–ö—Ä—É—Ç–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
      <div class="msg" id="msgBox"></div>
      <button class="confirm-btn" id="confirmBtn">–Ø –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É</button>
      <div class="wait-status" id="waitStatus" style="display:none;">
        <span class="wait-dot">‚óè</span> –û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞...
      </div>
    </div>
  </div>
  <div class="main-section" id="historySection">
    <div class="container">
      <div class="title" style="font-size:1.4em;">üèÜ –ú–æ–∏ –≤—ã–∏–≥—Ä—ã—à–∏</div>
      <div class="filterbar">
        <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
        <button class="filter-btn" data-filter="wait">–ù–µ –ø–æ–ª—É—á–µ–Ω–æ</button>
        <button class="filter-btn" data-filter="done">–ü–æ–ª—É—á–µ–Ω–æ</button>
      </div>
      <div class="history">
        <div class="history-cards" id="historyCards"></div>
      </div>
    </div>
  </div>
  <div class="main-section" id="profileSection">
    <div class="container" style="padding-top:22px;">
      <div class="title" style="font-size:1.4em;">‚öôÔ∏è –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
      <div class="profile" id="profileBox" style="margin:18px auto 25px auto;display:none;">
        <img class="profile-img" id="profileImg" src="" alt="User">
        <div class="profile-info">
          <span class="uname" id="profileName"></span>
          <span class="profile-id" id="profileId"></span>
        </div>
      </div>
      <button class="profile-edit-btn" style="margin-bottom:10px;display:none;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <div style="font-size:.97em;color:#ffe47a;margin-top:9px;">
        –ù–µ –∑–∞–±—É–¥—å –Ω–∞–ø–∏—Å–∞—Ç—å <b>@MrFerra</b> —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫!
      </div>
    </div>
  </div>
  <!-- TabBar -->
  <div class="tabbar" id="tabBar">
    <button class="tab-btn active" data-tab="rouletteSection"><span class="tab-btn-ic">üé∞</span> <span>–†—É–ª–µ—Ç–∫–∞</span></button>
    <button class="tab-btn" data-tab="historySection"><span class="tab-btn-ic">üèÜ</span> <span>–í—ã–∏–≥—Ä—ã—à–∏</span></button>
    <button class="tab-btn" data-tab="profileSection"><span class="tab-btn-ic">‚öôÔ∏è</span> <span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  </div>
  <!-- –ú–û–î–ê–õ -->
  <div class="modal-bg" id="modalBg">
    <div class="modal" id="modalWindow">
      <div class="big-emoji" id="modalEmoji"></div>
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-desc" id="modalDesc"></div>
      <button class="modal-btn" id="modalBtn">–û–∫</button>
    </div>
  </div>
  <div class="snackbar" id="snackbar"></div>
  <canvas class="confetti" id="confetti"></canvas>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
/* ---- CONFIG ---- */
const firebaseConfig = {
  apiKey: "AIzaSyDX8BiSqlghdgOj4_zPSyPgATfHVV5DNQI",
  authDomain: "gifts-d8f30.firebaseapp.com",
  projectId: "gifts-d8f30",
  storageBucket: "gifts-d8f30.firebasestorage.app",
  messagingSenderId: "883903383261",
  appId: "1:883903383261:web:dad1742c009ea38bf5fd34",
  measurementId: "G-5JFXH4YG3J"
};
const gifts = [
  { id: 5170145012310081615, emoji: "üíñ", name: "–°–µ—Ä–¥—Ü–µ" },
  { id: 5170233102089322756, emoji: "üß∏", name: "–ü–ª—é—à–µ–≤—ã–π –º–∏—à–∫–∞" }
];
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---- AUTH ---- */
let userId = null, userName = "", userPhoto = "";
function getTelegramUser() {
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
    const tgUser = Telegram.WebApp.initDataUnsafe.user;
    userId = tgUser.id;
    userName = (tgUser.username ? ("@" + tgUser.username) : tgUser.first_name || "User");
    userPhoto = tgUser.photo_url ? tgUser.photo_url : "https://telegram.org/img/t_logo.png";
    return tgUser;
  } else {
    showSnackbar("–û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –∏–∑ Telegram Mini App!");
    throw "Not in Telegram Mini App";
  }
}
const tgUser = getTelegramUser();
function saveUserOnEnter() {
  if (!userId) return;
  db.ref("users/" + userId).update({
    id: userId, name: userName, photo: userPhoto, lastVisit: new Date().toISOString()
  });
}
saveUserOnEnter();

/* ---- NAV ---- */
const tabs = ["rouletteSection","historySection","profileSection"];
function showTab(tab) {
  tabs.forEach(t=> {
    document.getElementById(t).classList.toggle('active',t===tab);
    document.querySelector('.tab-btn[data-tab="'+t+'"]').classList.toggle('active',t===tab);
  });
  if(tab==="historySection") loadHistory("all");
  if(tab==="profileSection") showProfile();
  window.scrollTo(0,0);
}
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.onclick = ()=> showTab(btn.getAttribute("data-tab"));
});

/* ---- SPLASH ---- */
const splash = document.getElementById("splashScreen");
document.getElementById("splashStartBtn").onclick = ()=>{
  splash.style.display = "none";
  showTab("rouletteSection");
}

/* ---- SWIPE ---- */
let touchStartX = 0, touchEndX = 0;
document.getElementById('app').addEventListener('touchstart',e=>{ if(e.touches.length===1) touchStartX=e.touches[0].clientX;});
document.getElementById('app').addEventListener('touchend',e=>{
  touchEndX = e.changedTouches[0].clientX;
  let dx = touchEndX-touchStartX;
  if(Math.abs(dx)<70) return;
  let idx = tabs.findIndex(t=>document.getElementById(t).classList.contains("active"));
  if(dx<0 && idx<tabs.length-1) showTab(tabs[idx+1]);
  if(dx>0 && idx>0) showTab(tabs[idx-1]);
});

/* ---- PROFILE ---- */
function showProfile() {
  if (!userId) return;
  document.getElementById('profileImg').src = userPhoto;
  document.getElementById('profileName').textContent = userName;
  document.getElementById('profileId').textContent = "ID: " + userId;
  document.getElementById('profileBox').style.display = '';
}

/* ---- HISTORY ---- */
let allSpinsCache = [];
function loadHistory(filter="all") {
  if (!userId) return;
  db.ref("users/" + userId + "/spins").on("value", snap => {
    let arr = [];
    snap.forEach(child => {
      let v = child.val();
      v._key = child.key;
      arr.push(v);
    });
    allSpinsCache = arr.reverse();
    showHistory(filter);
  });
}
function showHistory(filter="all") {
  let arr = allSpinsCache;
  if(filter==="wait") arr = arr.filter(x=>!x.done);
  if(filter==="done") arr = arr.filter(x=>x.done);
  let el = document.getElementById('historyCards');
  if(!arr.length) { el.innerHTML='<div style="color:#ffe47a;text-align:center;padding:17px 0 12px 0;">–ü–æ–∫–∞ –Ω–µ—Ç –≤—ã–∏–≥—Ä—ã—à–µ–π</div>'; return; }
  el.innerHTML = arr.map(x=>{
    let g=gifts.find(g=>g.id==x.gift)||{emoji:"üéÅ",name:"–ü–æ–¥–∞—Ä–æ–∫"};
    return `<div class="history-card">
      <div class="history-gift">${g.emoji}</div>
      <div class="history-info">
        <div class="history-name">${g.name}</div>
        <div class="history-time">${x.time||""}</div>
        <div class="history-status ${x.done?'':'wait'}">${x.done?'–ü–æ–ª—É—á–µ–Ω–æ':'–û–∂–∏–¥–∞–µ—Ç'}</div>
      </div>
    </div>`;
  }).join('');
}
document.querySelectorAll(".filter-btn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    showHistory(btn.getAttribute("data-filter"));
  };
});

/* ---- ROULETTE ---- */
const rouletteList = document.getElementById("rouletteList");
let isSpinning = false, selectedIdx = 0;
let slots = [];
function shuffle(arr) {
  let a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function fillRoulette(selected=-1) {
  slots = [];
  let l = 24; // –¥–ª–∏–Ω–∞ –ª–µ–Ω—Ç—ã
  let cycle = shuffle(gifts);
  let k = 0;
  for (let i=0; i<l; ++i) {
    slots.push(cycle[k]);
    k++; if (k>=cycle.length) { cycle = shuffle(gifts); k=0; }
  }
  rouletteList.innerHTML = "";
  for (let i=0; i<slots.length; ++i) {
    const gift = slots[i];
    const div = document.createElement("div");
    div.className = "item" + (i===selected ? " selected" : "");
    div.innerHTML = `<div class="gift-emoji">${gift.emoji}</div><div class="gift-name">${gift.name}</div>`;
    rouletteList.appendChild(div);
  }
}
fillRoulette();

/* ---- SPIN ---- */
document.getElementById("spinBtn").onclick = function() {
  if (isSpinning) return;
  isSpinning = true;
  document.getElementById('msgBox').classList.remove('visible');
  document.getElementById('confirmBtn').classList.remove('visible');
  document.getElementById('waitStatus').style.display="none";

  fillRoulette();
  const winGift = gifts[Math.random()<0.5?0:1];
  let winPos = slots.length - 1;
  for(let i=slots.length-1; i>=slots.length-8; i--) {
    if(slots[i].id === winGift.id) { winPos = i; break; }
  }
  selectedIdx = winPos;
  rouletteList.style.transition = "none";
  rouletteList.style.transform = "translateX(0)";

  setTimeout(()=> {
    rouletteList.style.transition = "transform 2.25s cubic-bezier(.11,.57,0,1)";
    const width = 108+14; // item+margin*2
    const offset = selectedIdx*width - (rouletteList.parentNode.offsetWidth/2) + width/2;
    rouletteList.style.transform = `translateX(${-offset}px)`;

    setTimeout(()=>{
      isSpinning = false;
      document.getElementById("spinBtn").disabled = false;
      for (let i=0;i<rouletteList.children.length;i++) rouletteList.children[i].classList.remove('win');
      rouletteList.children[selectedIdx].classList.add('win');
      // MODAL
      const gift = slots[selectedIdx];
      showModal(`${gift.emoji}`, "–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!", `<span style="font-size:1.08em;">${gift.name}</span><br>–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–ø–∏—à–∏—Ç–µ <b>@MrFerra</b>.<br>–ù–∞–∂–º–∏—Ç–µ ‚Äú–Ø –æ—Ç–ø—Ä–∞–≤–∏–ª‚Äù –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ.`);
      // FIREBASE
      const now = new Date();
      db.ref("users/"+userId).update({
        id: userId, name: userName, photo: userPhoto, lastSpin: now.toISOString()
      });
      let newSpin = db.ref("users/"+userId+"/spins").push();
      newSpin.set({
        gift: gift.id,
        time: now.toLocaleString(),
        done: false
      });
      loadHistory("all");
      confettiEffect();
      // –°–æ–æ–±—â–µ–Ω–∏–µ –∏ –∫–Ω–æ–ø–∫–∞ –Ω–∏–∂–µ
      document.getElementById('msgBox').innerHTML = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ <b>${gift.emoji} ${gift.name}</b>!<br>–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –Ω–∞–ø–∏—à–µ—Ç–µ <b>@MrFerra</b>, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.`;
      document.getElementById('msgBox').classList.add('visible');
      document.getElementById('confirmBtn').classList.add('visible');
    }, 2350);
  }, 60);
  document.getElementById("spinBtn").disabled = true;
  setTimeout(()=>{document.getElementById("spinBtn").disabled = false;}, 2950);
};

/* ---- CONFIRM ---- */
document.getElementById('confirmBtn').onclick = function() {
  // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–ø–∏–Ω–∞, –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  if (!allSpinsCache.length) return;
  let lastSpin = allSpinsCache[0];
  db.ref(`users/${userId}/spins/${lastSpin._key}`).update({wait: true});
  document.getElementById('msgBox').innerHTML = `<span style="font-size:1.15em;">–ñ–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞...</span>`;
  document.getElementById('confirmBtn').classList.remove('visible');
  document.getElementById('waitStatus').style.display="block";
};

/* ---- REALTIME CONFIRM ---- */
db.ref("users/"+userId+"/spins").on("child_changed", function(snap){
  let spin = snap.val();
  if(spin.done) {
    document.getElementById('waitStatus').style.display="none";
    showSnackbar("–ü–æ–¥–∞—Ä–æ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω! –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º üéâ");
    loadHistory("all");
  }
});

/* ---- SNACKBAR ---- */
function showSnackbar(msg, time=2700) {
  let sb = document.getElementById('snackbar');
  sb.textContent = msg;
  sb.className = "snackbar show";
  setTimeout(()=>{ sb.className = "snackbar"; }, time);
}

/* ---- MODAL ---- */
function showModal(emoji, title, desc) {
  document.getElementById('modalEmoji').textContent = emoji;
  document.getElementById('modalTitle').innerHTML = title;
  document.getElementById('modalDesc').innerHTML = desc;
  document.getElementById('modalBg').classList.add('active');
}
document.getElementById('modalBtn').onclick = ()=>{
  document.getElementById('modalBg').classList.remove('active');
};

/* ---- CONFETTI ---- */
function confettiEffect() {
  const colors = ["#ffd700", "#ff69b4", "#00e0ca", "#ffe579", "#f68c47", "#74dbef", "#f54555"];
  const canvas = document.getElementById("confetti");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  let pieces = [];
  for (let i = 0; i < 110; i++) {
    pieces.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height * 0.1,
      w: 7 + Math.random() * 8,
      h: 16 + Math.random() * 6,
      angle: Math.random() * 2 * Math.PI,
      color: colors[Math.floor(Math.random() * colors.length)],
      vy: 2 + Math.random() * 3,
      vx: (Math.random() - 0.5) * 2.5,
      va: (Math.random() - 0.5) * 0.08
    });
  }
  let frames = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let p of pieces) {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.angle);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
      p.x += p.vx;
      p.y += p.vy;
      p.angle += p.va;
      if (p.y > canvas.height) p.y = -20, p.x = Math.random()*canvas.width;
    }
    frames++;
    if (frames < 85) requestAnimationFrame(draw);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  draw();
}

/* ---- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ —á–µ—Ä–µ–∑ zoom (–ø—Ä–∏–º–µ—Ä) ---- */
// –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–ª—è —Å–ª–∞–±–æ–≤–∏–¥—è—â–∏—Ö:
// document.body.style.zoom = 1.2;

</script>
</body>
</html>


