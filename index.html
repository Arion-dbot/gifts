<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>TMA Gift-Roulette</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
/* ---------- –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ ---------- */
html,body{margin:0;padding:0;min-height:100vh;font-family:'Montserrat',sans-serif;background:linear-gradient(125deg,#181e24 0%,#242c36 100%);color:#fff}
.container{max-width:380px;margin:26px auto;background:#212633;border-radius:20px;box-shadow:0 6px 26px #000a;padding:26px 18px 24px;text-align:center}
.title{font-family:'Russo One',sans-serif;font-size:2.2rem;letter-spacing:1.4px;background:linear-gradient(90deg,#e4c05c,#ffefb0 55%,#baa86b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px;user-select:none}
.profile{display:flex;justify-content:center;gap:14px;align-items:center;margin-bottom:16px}
.profile-img{width:54px;height:54px;border-radius:50%;object-fit:cover;border:3px solid #ffd66f;background:#2b313b}
.uname{font-family:'Russo One';display:block;font-size:1.15rem;color:#ffe79c;margin-bottom:4px;word-break:break-word}
#profileId{font-size:.9rem;color:#ccc}
.roulette{margin:20px 0 18px;background:#181d22;border:2px solid #2e3441;border-radius:18px;position:relative;overflow:hidden;box-shadow:0 4px 18px #0006 inset;min-height:86px}
.marker{position:absolute;top:6px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:20px solid #f5cb4e;filter:drop-shadow(0 2px 6px #222a);z-index:3}
.roulette-list{display:flex;transition:transform 2.6s cubic-bezier(.11,.57,0,1);will-change:transform;align-items:center}
.item{min-width:76px;max-width:76px;height:76px;margin:0 6px;background:#242d3a;border-radius:13px;border:2px solid #222b;box-shadow:0 2px 10px #0007;display:flex;flex-direction:column;justify-content:center;align-items:center;font-size:1.5rem}
.item .gift-name{font-size:.9rem;color:#f3d48f;margin-top:6px;letter-spacing:.03em}
.item.win{border-color:#ffd700;box-shadow:0 0 14px 3px #ffd70055,0 2px 10px #000a;z-index:2}
/* –∫–Ω–æ–ø–∫–∏ */
.btn{width:90%;padding:15px;margin:0 auto;border:none;border-radius:16px;font-family:'Russo One';font-size:1.25rem;font-weight:700;cursor:pointer;transition:background .15s,transform .1s;box-shadow:0 2px 14px #0005}
.spin-btn{background:linear-gradient(90deg,#f5cb4e,#f9e67c 70%,#f5cb4e);color:#191f26}
.spin-btn:active{background:#f6e5a3;transform:scale(.97)}
.confirm-btn{background:#3ab54a;color:#fff;margin-top:14px}
.confirm-btn:active{background:#288033;transform:scale(.97)}
/* —Å–æ–æ–±—â–µ–Ω–∏—è */
.msg{background:#262c36;border-radius:12px;padding:16px 10px;font-size:1.1rem;box-shadow:0 2px 8px #0004 inset;line-height:1.55;margin-top:18px}
.snackbar{position:fixed;left:50%;bottom:28px;transform:translateX(-50%);padding:14px 22px;border-radius:12px;color:#fff;font-weight:600;font-size:1rem;opacity:0;pointer-events:none;transition:opacity .4s,transform .4s}
.snackbar.show{opacity:1;transform:translate(-50%,0)}
.snackbar.info{background:#4a90e2}.snackbar.error{background:#e85454}.snackbar.success{background:#3ab54a}
/* history */
.history{background:#242d3a;border-radius:13px;margin-top:24px;padding:12px 10px;text-align:left;font-size:.93rem;color:#ddd}
.history h4{margin:0 0 8px;color:#e8c067;font-size:1.1rem}
.history ul{margin:0;padding-left:16px}
.history li{margin-bottom:2px;color:#eee;font-size:.9rem}
@media(max-width:480px){.container{max-width:96vw;margin:12px auto}.item{min-width:64px;max-width:64px;height:64px}.profile-img{width:46px;height:46px}}
</style>
</head>
<body>
<div class="container">
  <div class="profile" id="profileBox" style="display:none">
    <img id="profileImg" class="profile-img" src="">
    <div>
      <span id="profileName" class="uname"></span>
      <span id="profileId"></span>
    </div>
  </div>
  <div class="title">Gift Roulette</div>

  <div class="roulette" id="roulette">
    <div class="marker"></div>
    <div class="roulette-list" id="rouletteList"></div>
  </div>

  <button class="btn spin-btn" id="spinBtn">–ö—Ä—É—Ç–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
  <div class="msg" id="msgBox" style="display:none"></div>
  <button class="btn confirm-btn" id="confirmBtn" style="display:none">–Ø —É–∂–µ –Ω–∞–ø–∏—Å–∞–ª –±–æ—Ç—É</button>

  <div class="history" id="historyBox">
    <h4>–ò—Å—Ç–æ—Ä–∏—è –≤—ã–∏–≥—Ä—ã—à–µ–π</h4>
    <ul id="historyList"></ul>
  </div>
</div>

<!-- Snackbar -->
<div id="snackbar" class="snackbar"></div>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* ---------- 1. –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥ ---------- */
// TODO: YOUR_FIREBASE_CONFIG
const firebaseConfig = {/* ... */};

const gifts = [
  {id:5170145012310081615,emoji:"üíñ",name:"–°–µ—Ä–¥—Ü–µ"},
  {id:5170233102089322756,emoji:"üß∏",name:"–ú–∏—à–∫–∞"}
];
const maxPerGift=5;                 // —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –º–æ–∂–Ω–æ –≤—ã–¥–∞—Ç—å –∫–∞–∂–¥—ã–π –ø—Ä–∏–∑ –¥–æ —Å–±—Ä–æ—Å–∞
const SPIN_COOLDOWN=2000;           // ms —Å –∫–æ–Ω—Ü–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø–∏–Ω–∞

/* ---------- 2. Firebase ---------- */
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* ---------- 3. Snackbar ---------- */
function showSnack(text,type='info',ms=2800){
  const s=document.getElementById('snackbar');
  s.textContent=text;
  s.className=`snackbar ${type} show`;
  setTimeout(()=>s.classList.remove('show'),ms);
}

/* ---------- 4. Telegram auth (or TEST mode) ---------- */
let userId=null,userName='',userPhoto='';
const TEST_MODE=false; // ‚Üê true –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –±–µ–∑ Telegram
if(TEST_MODE){
  userId=123456789;
  userName='@TestUser';
  userPhoto='https://telegram.org/img/t_logo.png';
}else{
  const u=Telegram.WebApp?.initDataUnsafe?.user;
  if(!u){showSnack("–û—Ç–∫—Ä–æ–π—Ç–µ –∏–∑ Telegram!",'error',4000);throw'notTelegram';}
  userId=u.id;
  userName=u.username?`@${u.username}`:u.first_name||'User';
  userPhoto=u.photo_url||'https://telegram.org/img/t_logo.png';
}
document.getElementById('profileImg').src=userPhoto;
document.getElementById('profileName').textContent=userName;
document.getElementById('profileId').textContent=`ID: ${userId}`;
document.getElementById('profileBox').style.display='flex';

/* ---- –∑–∞–ø–∏—Å—å —é–∑–µ—Ä–∞ –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ ---- */
db.ref('users/'+userId).update({
  id:userId,name:userName,photo:userPhoto,lastVisit:new Date().toISOString()
});

/* ---------- 5. –ò—Å—Ç–æ—Ä–∏—è ---------- */
function loadHistory(){
  db.ref(`users/${userId}/spins`).once('value',snap=>{
    const arr=[];
    snap.forEach(c=>{
      const v=c.val();
      const g=gifts.find(x=>x.id==v.gift);
      arr.push(`${v.time}: ${g?g.emoji:'üéÅ'} <b>${g?g.name:'–ü–æ–¥–∞—Ä–æ–∫'}</b>`);
    });
    document.getElementById('historyList').innerHTML=arr.length?arr.map(x=>`<li>${x}</li>`).join(''):'<li>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</li>';
  });
}
window.onload=loadHistory;

/* ---------- 6. –†—É–ª–µ—Ç–∫–∞ ---------- */
const rouletteList=document.getElementById('rouletteList');
function fillRoulette(){
  rouletteList.innerHTML='';
  const loops=6; // –≤–∏–∑—É–∞–ª—å–Ω–æ –¥–ª–∏–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞
  for(let i=0;i<gifts.length*loops;i++){
    const g=gifts[i%gifts.length];
    const d=document.createElement('div');
    d.className='item';
    d.innerHTML=`<div style="font-size:2.2em">${g.emoji}</div><div class="gift-name">${g.name}</div>`;
    rouletteList.appendChild(d);
  }
}
fillRoulette();

/* ---------- 7. —Å—á—ë—Ç—á–∏–∫–∏ –ø—Ä–∏–∑–æ–≤ ---------- */
let availGifts=[...gifts];
function refreshGiftCounts(cb){
  db.ref('prizes').once('value',snap=>{
    const used={};snap.forEach(c=>used[c.key]=c.val());
    availGifts=gifts.filter(g=>(used[g.id]||0)<maxPerGift);
    if(availGifts.length===0){db.ref('prizes').set(null);availGifts=[...gifts];}
    cb&&cb();
  });
}

/* ---------- 8. –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫ ---------- */
let spinning=false,lastSpinEnd=0;
document.getElementById('spinBtn').onclick=()=>{
  if(spinning||Date.now()-lastSpinEnd<SPIN_COOLDOWN){showSnack("–ü–æ–¥–æ–∂–¥–∏—Ç–µ...",'info');return;}
  refreshGiftCounts(()=>startSpin());
};

function startSpin(){
  if(availGifts.length===0){showSnack("–ü—Ä–∏–∑—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",'error');return;}
  spinning=true;
  document.getElementById('msgBox').style.display='none';
  document.getElementById('confirmBtn').style.display='none';

  // —à–∞–Ω—Å 50/50
  const winGift = Math.random()<0.5 ? gifts[0] : gifts[1];
  const loops=16+Math.floor(Math.random()*5);
  const winIdxBase=gifts.findIndex(g=>g.id===winGift.id);
  const finalIdx=loops*gifts.length+winIdxBase;

  rouletteList.style.transition='none';
  rouletteList.style.transform='translateX(0)';
  setTimeout(()=>{
    rouletteList.style.transition='transform 2.7s cubic-bezier(.11,.57,0,1)';
    const cardW=76+12;
    const offset=finalIdx*cardW - (rouletteList.parentNode.offsetWidth/2) + cardW/2;
    rouletteList.style.transform=`translateX(${-offset}px)`;
    setTimeout(()=>finishSpin(winGift,finalIdx),2750);
  },60);
}

function finishSpin(gift,finalIdx){
  spinning=false;lastSpinEnd=Date.now();
  [...rouletteList.children].forEach(c=>c.classList.remove('win'));
  rouletteList.children[finalIdx].classList.add('win');
  playConfetti();

  // —Å–æ–æ–±—â–µ–Ω–∏–µ
  const msgBox=document.getElementById('msgBox');
  msgBox.innerHTML=`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ <b>${gift.emoji} ${gift.name}</b>!<br>
    –ù–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É <a href="https://t.me/MrFerra" target="_blank">@MrFerra</a>,<br>
    –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.`;
  msgBox.style.display='';
  document.getElementById('confirmBtn').style.display='';

  // –∑–∞–ø–∏—Å—å –≤ –ë–î
  const now=new Date();
  db.ref(`prizes/${gift.id}`).transaction(c=>(c||0)+1);
  db.ref(`users/${userId}`).update({lastSpin:now.toISOString()});
  db.ref(`users/${userId}/spins`).push({
    gift:gift.id,time:now.toLocaleString(),unix:now.getTime(),avatar:userPhoto
  });
  loadHistory();
}

/* ---------- 9. Confetti ---------- */
function playConfetti(){
  const duration=1800,end=Date.now()+duration;
  (function frame(){
    confetti({particleCount:16,startVelocity:21,spread:70,origin:{y:0.4}});
    if(Date.now()<end)requestAnimationFrame(frame);
  })();
}

/* ---------- 10. Confirm ---------- */
document.getElementById('confirmBtn').onclick=()=>{
  db.ref(`users/${userId}`).update({confirmed:new Date().toISOString()});
  document.getElementById('msgBox').innerHTML='–ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ—á–µ–Ω ‚úÖ. –ü–æ–¥–∞—Ä–æ–∫ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!';
  document.getElementById('confirmBtn').style.display='none';
  showSnack("–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ",'success');
};
</script>
</body>
</html>

