<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Gift Roulette ‚Äî TMA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css?family=Russo+One|Montserrat:600,400&display=swap" rel="stylesheet">
  <style>
    html,body { background: linear-gradient(120deg, #181e24 0%, #23272f 100%); min-height: 100vh;
      font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; color: #fff;}
    body { overscroll-behavior-y: contain;}
    .splash { position:fixed; z-index:999; inset:0; background:linear-gradient(120deg,#23243a,#181e24 90%); display:flex; flex-direction:column; align-items:center; justify-content:center; transition:opacity .7s; }
    .splash .logo { font-family:'Russo One'; font-size:2.7rem; color:#ffd700; margin-bottom:16px;}
    .splash .desc { font-size:1.2rem; color:#fff; opacity:.88; margin-bottom:34px;}
    .splash-btn {background:linear-gradient(90deg,#ffd700 40%,#ffe98b); color:#191f26;font-size:1.16rem; font-family:'Russo One';
      border:none; border-radius:18px; padding:17px 46px; box-shadow:0 3px 24px #0003; cursor:pointer;transition:.14s;}
    .splash-btn:active {background:#ffe24b;}
    .main-wrap {display:none;}
    .container { max-width: 380px; margin: 24px auto 90px auto; background: #212633;
      border-radius: 20px; box-shadow: 0 6px 28px #000a; padding: 24px 10px 18px 10px; text-align: center; position: relative;}
    .profile { display: flex; align-items: center; margin-bottom: 16px; gap: 16px; justify-content: center;}
    .profile-img { width: 54px; height: 54px; border-radius: 50%; object-fit: cover; border: 2.5px solid #ffe48a; background: #191c22;}
    .profile-info { text-align: left; font-size: 1.05rem; max-width: 200px; overflow: hidden;}
    .profile-info .uname { color: #ffe79c; font-family: 'Russo One', Arial, sans-serif; font-size: 1.18rem; margin-bottom: 3px; display: block;}
    .title { font-family: 'Russo One', Arial, sans-serif; font-size: 2.2rem; letter-spacing: 1.5px; margin-bottom: 4px;
      background: linear-gradient(90deg, #e4c05c, #ffefb0 60%, #b0a871); -webkit-background-clip: text;
      -webkit-text-fill-color: transparent; display: inline-block;}
    .tabs {position:fixed; left:0; right:0; bottom:0; height:68px; background:#212633e6; box-shadow:0 -2px 14px #0004;
      display:flex; z-index:20;}
    .tab-btn {flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:1.2em;
      color:#bfc3d9; font-family:'Russo One'; cursor:pointer; transition:.13s;}
    .tab-btn .tab-icon {font-size:1.8em; margin-bottom:1px;}
    .tab-btn.active {color:#ffd700;}
    .tab-label {font-size:0.99em; margin-top:1px;}
    /* Roulette */
    .roulette { background: #181d22; border: 2px solid #2f3642; border-radius: 24px; box-shadow: 0 4px 18px #0006 inset;
      margin: 18px 0 18px 0; padding: 22px 0 18px 0; position: relative; overflow: hidden; min-height: 110px; user-select: none;}
    .roulette-list { display: flex; will-change: transform; align-items: center; transition:transform 2.6s cubic-bezier(.11,.57,0,1);}
    .item { min-width: 90px; max-width: 90px; height: 90px; margin: 0 10px; background: #242d3a; border-radius: 18px;
      box-shadow: 0 2px 10px #0007; display: flex; flex-direction: column; justify-content: center; align-items: center;
      border: 2.5px solid #222b; font-size: 2.1rem; transition: border .12s, box-shadow .15s;}
    .item.selected, .item.win { border-color: #ffd700; box-shadow: 0 0 24px 4px #ffd70077, 0 2px 10px #000a; z-index: 2;}
    .item .gift-emoji {font-size:2.6em; transition:.3s cubic-bezier(.33,1.22,.64,1.15);}
    .item .gift-emoji.bounce {animation:bounceEmoji .65s;}
    .item .gift-name { font-size: 1.13rem; color: #f4d58b; margin-top: 7px; letter-spacing: .03em;}
    @keyframes bounceEmoji { 0%{transform:scale(1);} 45%{transform:scale(1.38) rotate(-10deg);} 60%{transform:scale(0.95) rotate(4deg);}
      75%{transform:scale(1.09);} 100%{transform:scale(1);} }
    .marker { position: absolute; top: 6px; left: 50%; transform: translateX(-50%); z-index: 2; width: 0; height: 0;
      border-left: 18px solid transparent; border-right: 18px solid transparent; border-bottom: 25px solid #f5cb4e;
      filter: drop-shadow(0 2px 6px #222a);}
    .spin-btn { margin-top: 28px; width: 92%; padding: 18px; border-radius: 20px;
      background: linear-gradient(90deg, #f5cb4e, #f9e67c 70%, #f5cb4e); color: #191f26;
      font-family: 'Russo One', Arial, sans-serif; font-size: 1.4rem; letter-spacing: .07em;
      border: none; outline: none; box-shadow: 0 2px 18px #0006; cursor: pointer; font-weight: 700;
      transition: background .15s, transform .12s;}
    .spin-btn:active:not(:disabled), .spin-btn:focus:not(:disabled) {background: #f6e5a3; transform: scale(1.06);}
    .spin-btn:disabled { opacity: 0.55; cursor:not-allowed;}
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal {position:fixed;z-index:100;inset:0;display:flex;align-items:center;justify-content:center;background:#191e2abb;
      animation:fadeInModal .4s;}
    .modal-box {background:#242c3c; padding:34px 26px 30px 26px; border-radius:20px; box-shadow:0 3px 24px #0007; min-width: 240px;
      display:flex; flex-direction:column; align-items:center;}
    .modal .gift-emoji {font-size:4.2rem; margin-bottom:12px;}
    .modal .modal-title {font-size:1.6rem; color:#ffd700; font-family:'Russo One'; margin-bottom:7px;}
    .modal .modal-msg {font-size:1.11rem; margin-bottom:22px;}
    .modal .modal-btn {font-size:1.11rem; background:#ffd700; color:#181d22; padding:11px 36px; border:none; border-radius:13px; font-weight:700; margin-top:4px;cursor:pointer;}
    @keyframes fadeInModal {from{opacity:0;} to{opacity:1;}}
    .msg { background: #262c36; border-radius: 13px; margin: 22px 0 12px 0; padding: 19px 9px 16px 9px;
      font-size: 1.14rem; box-shadow: 0 2px 8px #0004 inset; line-height: 1.55; min-height: 60px; display: none;}
    .msg.visible { display: block; }
    .confirm-btn { background: #3ab54a; color: #fff; padding: 13px 34px; border-radius: 13px; font-size: 1.15rem;
      font-weight: 700; margin-top: 14px; border: none; cursor: pointer; transition: background .14s; display: none;}
    .confirm-btn:active { background: #278030; }
    .confirm-btn.visible { display: inline-block; }
    .snackbar { visibility: hidden; min-width: 180px; background: #242d3a; color: #fff; text-align: center;
      border-radius: 11px; padding: 13px 22px; position: fixed; z-index: 99; left: 50%; bottom: 40px; transform: translateX(-50%);
      font-size: 1rem; box-shadow: 0 2px 14px #0007; transition: visibility 0s, opacity .35s cubic-bezier(.4,.01,0,1), bottom .23s;
      opacity: 0; pointer-events: none;}
    .snackbar.show { visibility: visible; opacity: 1; pointer-events: auto; bottom: 65px;}
    .history { background: #242d3a; border-radius: 15px; margin-top: 18px; padding: 10px 8px 9px 8px;
      text-align: left; font-size: 1.05rem; color: #ccc; min-height: 38px; box-shadow: 0 2px 9px #0003;}
    .history-header {display:flex;align-items:center;gap:12px;}
    .filter-btn {background:#191f26;color:#ffd700;padding:5px 14px; border-radius:8px; border:none;cursor:pointer; font-size:0.97em;}
    .filter-btn.active {background:#ffd700;color:#191f26;}
    .history-cards {margin-top:6px;}
    .history-card {display:flex;align-items:center;gap:16px; background:#262c36; border-radius:10px;padding:8px 7px 9px 11px;margin-bottom:9px;}
    .history-emoji {font-size:2.1em;}
    .history-info {flex:1;}
    .history-name {font-size:1.11em;font-weight:600;}
    .history-date {font-size:0.93em; color:#bbb;}
    .history-status {font-size:0.94em; font-weight:500; color:#62da73; margin-top:1px;}
    .history-status.wait {color:#ffd700;}
    .history-status.none {color:#ea8888;}
    /* Loader / –æ–∂–∏–¥–∞–Ω–∏–µ */
    .wait-loader {display:inline-block;width:34px;height:34px;position:relative;}
    .wait-loader div {box-sizing:border-box;display:block;position:absolute;width:34px;height:34px;border:4px solid #ffd700;border-radius:50%;animation:loaderSpin 1.1s linear infinite;border-color:#ffd700 transparent transparent transparent;}
    .wait-loader div:nth-child(1) {animation-delay:-0.32s;}
    .wait-loader div:nth-child(2) {animation-delay:-0.16s;}
    @keyframes loaderSpin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .confetti { position: fixed; pointer-events: none; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 120;
      overflow: hidden; pointer-events: none;}
    @media (max-width: 480px) {
      .container { max-width: 99vw; margin: 10px 2vw 90px 2vw;}
      .roulette { min-height: 70px; }
      .item { min-width: 67px; max-width: 67px; height: 67px;}
      .profile-img { width: 39px; height: 39px;}
      .modal-box {min-width:180px;}
      .tabs {height:59px;}
    }
    @media (max-width:340px) {
      .item { min-width:50px; max-width:50px; height: 50px;}
      .roulette {min-height:40px;}
    }
  </style>
  <!-- Tab icons: emoji (for simplicity) -->
</head>
<body>
<div class="splash" id="splashScreen">
  <div class="logo">üé≤ Gift Roulette</div>
  <div class="desc">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–¥–∞—á—É –∏ –≤—ã–∏–≥—Ä–∞–π—Ç–µ –ø—Ä–∏–∑—ã.<br>–ö—Ä—É—Ç–∏—Ç–µ —Ä—É–ª–µ—Ç–∫—É ‚Äî –≤—Å—ë —á–µ—Å—Ç–Ω–æ!</div>
  <button class="splash-btn" id="splashStartBtn">–ù–∞—á–∞—Ç—å</button>
</div>
<div class="main-wrap" id="mainWrap">
  <div class="container">
    <div class="profile" id="profileBox" style="display:none;">
      <img class="profile-img" id="profileImg" src="" alt="User">
      <div class="profile-info">
        <span class="uname" id="profileName"></span>
        <span id="profileId"></span>
      </div>
    </div>
    <div id="tab-roulette" class="tab-section">
      <div class="title">Gift Roulette</div>
      <div class="roulette" id="roulette">
        <div class="marker"></div>
        <div class="roulette-list" id="rouletteList"></div>
      </div>
      <button class="spin-btn" id="spinBtn">–ö—Ä—É—Ç–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
    </div>
    <div id="tab-history" class="tab-section" style="display:none;">
      <div class="title">–ú–æ–∏ –≤—ã–∏–≥—Ä—ã—à–∏</div>
      <div class="history-header">
        <button class="filter-btn active" id="filterAll">–í—Å–µ</button>
        <button class="filter-btn" id="filterUnclaimed">–ù–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ</button>
      </div>
      <div class="history-cards" id="historyList"></div>
    </div>
    <div id="tab-profile" class="tab-section" style="display:none;">
      <div class="title">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div style="margin-top:28px;margin-bottom:12px;">
        <img class="profile-img" id="profileImg2" src="" alt="User">
        <div class="profile-info" style="display:inline-block;vertical-align:top;margin-left:10px;">
          <span class="uname" id="profileName2"></span>
          <span id="profileId2"></span>
        </div>
      </div>
      <div style="font-size:1.1em;margin-top:16px;color:#ffde87;">–£–¥–∞—á–∏ –≤ –∏–≥—Ä–µ!</div>
    </div>
    <div class="msg" id="msgBox"></div>
    <button class="confirm-btn" id="confirmBtn">–Ø –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É</button>
    <div style="text-align:center;margin:16px;">
      <div id="waitBox" style="display:none;"><span class="wait-loader"><div></div><div></div><div></div><div></div></span>
      <div id="waitMsg" style="font-size:1.09em;color:#ffe57c;margin-top:8px;">–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...</div></div>
    </div>
  </div>
  <div class="tabs" id="tabBar">
    <div class="tab-btn active" data-tab="tab-roulette"><span class="tab-icon">üé∞</span><span class="tab-label">–†—É–ª–µ—Ç–∫–∞</span></div>
    <div class="tab-btn" data-tab="tab-history"><span class="tab-icon">üéÅ</span><span class="tab-label">–í—ã–∏–≥—Ä—ã—à–∏</span></div>
    <div class="tab-btn" data-tab="tab-profile"><span class="tab-icon">üë§</span><span class="tab-label">–ü—Ä–æ—Ñ–∏–ª—å</span></div>
  </div>
</div>
<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è Win -->
<div id="modalWin" class="modal" style="display:none;">
  <div class="modal-box">
    <div class="gift-emoji" id="modalGiftEmoji"></div>
    <div class="modal-title" id="modalWinTitle">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!</div>
    <div class="modal-msg" id="modalWinMsg"></div>
    <button class="modal-btn" id="modalWinOkBtn">OK</button>
  </div>
</div>
<div class="snackbar" id="snackbar"></div>
<canvas class="confetti" id="confetti"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDX8BiSqlghdgOj4_zPSyPgATfHVV5DNQI",
  authDomain: "gifts-d8f30.firebaseapp.com",
  projectId: "gifts-d8f30",
  storageBucket: "gifts-d8f30.firebasestorage.app",
  messagingSenderId: "883903383261",
  appId: "1:883903383261:web:dad1742c009ea38bf5fd34",
  measurementId: "G-5JFXH4YG3J"
};
const gifts = [
  { id: 5170145012310081615, emoji: "üíñ", name: "–°–µ—Ä–¥—Ü–µ" },
  { id: 5170233102089322756, emoji: "üß∏", name: "–ü–ª—é—à–µ–≤—ã–π –º–∏—à–∫–∞" }
];

// Firebase init
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let userId = null, userName = "", userPhoto = "";
function getTelegramUser() {
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
    const tgUser = Telegram.WebApp.initDataUnsafe.user;
    userId = tgUser.id;
    userName = (tgUser.username ? ("@" + tgUser.username) : tgUser.first_name || "User");
    userPhoto = tgUser.photo_url ? tgUser.photo_url : "https://telegram.org/img/t_logo.png";
    return tgUser;
  } else {
    showSnackbar("–û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –∏–∑ Telegram Mini App!");
    throw "Not in Telegram Mini App";
  }
}

function saveUserOnEnter() {
  if (!userId) return;
  db.ref("users/" + userId).update({
    id: userId,
    name: userName,
    photo: userPhoto,
    lastVisit: new Date().toISOString()
  });
}

function showProfile() {
  if (!userId) return;
  ['profileImg','profileImg2'].forEach(id=>document.getElementById(id).src=userPhoto);
  ['profileName','profileName2'].forEach(id=>document.getElementById(id).textContent=userName);
  ['profileId','profileId2'].forEach(id=>document.getElementById(id).textContent="ID: "+userId);
  document.getElementById('profileBox').style.display = '';
}

// Splash screen
document.getElementById("splashStartBtn").onclick = function() {
  document.getElementById("splashScreen").style.opacity = "0";
  setTimeout(()=>{
    document.getElementById("splashScreen").style.display = "none";
    document.getElementById("mainWrap").style.display = "";
    // Init Telegram user
    getTelegramUser();
    saveUserOnEnter();
    showProfile();
    fillRoulette();
    loadHistory();
    swipeSupport();
  }, 600);
};

let isSpinning = false, selectedIdx = 0, slots = [];
function shuffle(arr) {
  let a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function fillRoulette(selected=-1) {
  slots = [];
  let l = 28;
  let cycle = shuffle(gifts);
  let k = 0;
  for (let i=0; i<l; ++i) {
    slots.push(cycle[k]);
    k++;
    if (k>=cycle.length) { cycle = shuffle(gifts); k=0; }
  }
  let rl = document.getElementById("rouletteList");
  rl.innerHTML = "";
  for (let i=0; i<slots.length; ++i) {
    const gift = slots[i];
    const div = document.createElement("div");
    div.className = "item" + (i===selected ? " selected" : "");
    div.innerHTML = `<div class="gift-emoji">${gift.emoji}</div><div class="gift-name">${gift.name}</div>`;
    rl.appendChild(div);
  }
}

document.getElementById("spinBtn").onclick = function() {
  if (isSpinning) return;
  isSpinning = true;
  document.getElementById('msgBox').classList.remove('visible');
  document.getElementById('confirmBtn').classList.remove('visible');
  document.getElementById("waitBox").style.display = "none";
  fillRoulette();
  const winGift = gifts[Math.random()<0.5?0:1];
  let winPos = slots.length - 1;
  for(let i=slots.length-1; i>=slots.length-8; i--) {
    if(slots[i].id === winGift.id) { winPos = i; break; }
  }
  selectedIdx = winPos;
  let rl = document.getElementById("rouletteList");
  rl.style.transition = "none";
  rl.style.transform = "translateX(0)";
  setTimeout(()=> {
    rl.style.transition = "transform 2.4s cubic-bezier(.11,.57,0,1)";
    const width = 90+20;
    const offset = selectedIdx*width - (rl.parentNode.offsetWidth/2) + width/2;
    rl.style.transform = `translateX(${-offset}px)`;
    setTimeout(()=>{
      isSpinning = false;
      document.getElementById("spinBtn").disabled = false;
      for (let i=0;i<rl.children.length;i++) rl.children[i].classList.remove('win');
      rl.children[selectedIdx].classList.add('win');
      let emojiDiv = rl.children[selectedIdx].querySelector('.gift-emoji');
      emojiDiv.classList.add("bounce");
      setTimeout(()=>emojiDiv.classList.remove("bounce"),900);
      showWinModal(slots[selectedIdx]);
      confettiEffect();
      // –ó–∞–ø–∏—Å—å –≤ –±–∞–∑—É
      const now = new Date();
      db.ref("users/"+userId).update({
        id: userId,
        name: userName,
        photo: userPhoto,
        lastSpin: now.toISOString()
      });
      let prizeKey = db.ref("users/"+userId+"/spins").push({
        gift: slots[selectedIdx].id,
        time: now.toLocaleString(),
        status: "wait"
      }).key;
      loadHistory();
      // –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ –ø–æ–∫–∞–∂–µ–º –¥–∞–ª—å—à–µ
      document.getElementById("modalWinOkBtn").onclick = function() {
        document.getElementById("modalWin").style.display="none";
        document.getElementById('msgBox').innerHTML = `<b>–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–∑, <a href="https://t.me/MrFerra" target="_blank">@MrFerra</a></b><br>
        –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.`;
        document.getElementById('msgBox').classList.add('visible');
        document.getElementById('confirmBtn').classList.add('visible');
        document.getElementById("waitBox").style.display = "none";
      };
    }, 2450);
  }, 80);
  document.getElementById("spinBtn").disabled = true;
  setTimeout(()=>{document.getElementById("spinBtn").disabled = false;}, 3200);
};

function showWinModal(gift){
  document.getElementById("modalGiftEmoji").textContent = gift.emoji;
  document.getElementById("modalWinTitle").textContent = "–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!";
  document.getElementById("modalWinMsg").innerHTML = `<b>${gift.name}</b><br>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!`;
  document.getElementById("modalWin").style.display = "flex";
}

document.getElementById('confirmBtn').onclick = function() {
  db.ref("users/"+userId+"/spins").once("value", snap=>{
    let key=null;
    snap.forEach(child=>{
      if(child.val().status==="wait") key=child.key;
    });
    if(key){
      db.ref("users/"+userId+"/spins/"+key).update({status:"pending"});
    }
  });
  document.getElementById('msgBox').innerHTML = `<span style="font-size:1.18em;color:#ffd700;">–°–ø–∞—Å–∏–±–æ!</span><br>–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–º–µ—á–µ–Ω–∞.<br>–û–∂–∏–¥–∞–π—Ç–µ –≤—ã–¥–∞—á—É –ø–æ–¥–∞—Ä–∫–∞ –±–æ—Ç–æ–º.`;
  document.getElementById('confirmBtn').classList.remove('visible');
  document.getElementById("waitBox").style.display = "";
  waitForPrize();
};
function waitForPrize(){
  // –†–µ–∞–ª—Ç–∞–π–º —Å–ª—É—à–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  db.ref("users/"+userId+"/spins").on("value", snap=>{
    snap.forEach(child=>{
      let v=child.val();
      if(v.status==="done"){
        document.getElementById("waitMsg").innerHTML = '<span style="color:#62da73">–ü—Ä–∏–∑ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω!<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à Telegram üéâ</span>';
        setTimeout(()=>{document.getElementById("waitBox").style.display="none";},2000);
      }
    });
    loadHistory();
  });
}

let historyFilter = "all";
function loadHistory() {
  if (!userId) return;
  db.ref("users/" + userId + "/spins").once("value", snap => {
    let arr = [];
    snap.forEach(child => {
      let v = child.val();
      v.key = child.key;
      arr.push(v);
    });
    arr.reverse();
    let html = '';
    arr.filter(item=>historyFilter==='all'||item.status!=='done').forEach(v=>{
      let g = gifts.find(g=>g.id==v.gift) || gifts[0];
      let status = v.status==="done"
        ? '<span class="history-status">–ü–æ–ª—É—á–µ–Ω–æ</span>'
        : (v.status==="pending"
            ? '<span class="history-status wait">–û–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏</span>'
            : '<span class="history-status none">–ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>');
      html += `<div class="history-card">
        <div class="history-emoji">${g.emoji}</div>
        <div class="history-info">
          <div class="history-name">${g.name}</div>
          <div class="history-date">${v.time||""}</div>
          ${status}
        </div>
      </div>`;
    });
    document.getElementById('historyList').innerHTML = html || '<div style="color:#ccc;padding:16px;text-align:center;">–ù–µ—Ç –≤—ã–∏–≥—Ä—ã—à–µ–π</div>';
  });
}
document.getElementById('filterAll').onclick = function(){historyFilter='all';this.classList.add('active');document.getElementById('filterUnclaimed').classList.remove('active');loadHistory();};
document.getElementById('filterUnclaimed').onclick = function(){historyFilter='notdone';this.classList.add('active');document.getElementById('filterAll').classList.remove('active');loadHistory();};

// Tab bar & section logic + swipe
[...document.querySelectorAll('.tab-btn')].forEach(btn=>{
  btn.onclick = function() {
    [...document.querySelectorAll('.tab-btn')].forEach(b=>b.classList.remove('active'));
    this.classList.add('active');
    let tab = this.getAttribute('data-tab');
    [...document.querySelectorAll('.tab-section')].forEach(sec=>sec.style.display='none');
    document.getElementById(tab).style.display='';
  }
});
function swipeSupport(){
  let wrap = document.querySelector('.container');
  let startX = null;
  wrap.addEventListener('touchstart', e=>{startX = e.touches[0].clientX;});
  wrap.addEventListener('touchmove', e=>{
    if(startX!==null){
      let dx = e.touches[0].clientX - startX;
      if(Math.abs(dx)>60){
        let tabs = ['tab-roulette','tab-history','tab-profile'];
        let curTab = tabs.findIndex(t=>document.getElementById(t).style.display!=='none');
        if(dx<0 && curTab<tabs.length-1){
          document.querySelectorAll('.tab-btn')[curTab+1].click();
        } else if(dx>0 && curTab>0){
          document.querySelectorAll('.tab-btn')[curTab-1].click();
        }
        startX = null;
      }
    }
  });
  wrap.addEventListener('touchend', ()=>{startX=null;});
}

/* ---- 10. SNACKBAR ---- */
function showSnackbar(msg, time=2800) {
  let sb = document.getElementById('snackbar');
  sb.textContent = msg;
  sb.className = "snackbar show";
  setTimeout(()=>{ sb.className = "snackbar"; }, time);
}

/* ---- 11. CONFETTI ---- */
function confettiEffect() {
  const colors = ["#ffd700", "#ff69b4", "#00e0ca", "#ffe579", "#f68c47", "#74dbef", "#f54555"];
  const canvas = document.getElementById("confetti");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  let pieces = [];
  for (let i = 0; i < 110; i++) {
    pieces.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height * 0.1,
      w: 7 + Math.random() * 8,
      h: 16 + Math.random() * 6,
      angle: Math.random() * 2 * Math.PI,
      color: colors[Math.floor(Math.random() * colors.length)],
      vy: 2 + Math.random() * 3,
      vx: (Math.random() - 0.5) * 2.5,
      va: (Math.random() - 0.5) * 0.08
    });
  }
  let frames = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let p of pieces) {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.angle);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
      p.x += p.vx;
      p.y += p.vy;
      p.angle += p.va;
      if (p.y > canvas.height) p.y = -20, p.x = Math.random()*canvas.width;
    }
    frames++;
    if (frames < 85) requestAnimationFrame(draw);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  draw();
}
</script>
</body>
</html>
