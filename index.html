<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Gift Roulette ‚Äî CS:GO Case Style</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css?family=Russo+One|Montserrat:600,400&display=swap" rel="stylesheet">
  <style>
    html,body {
      background: linear-gradient(120deg, #181e24 0%, #23272f 100%);
      min-height: 100vh;
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
      color: #fff;
    }
    .container {
      max-width: 380px;
      margin: 32px auto;
      background: #212633;
      border-radius: 20px;
      box-shadow: 0 6px 28px #000a;
      padding: 30px 18px 24px 18px;
      text-align: center;
      position: relative;
      overflow: visible;
    }
    .profile {
      display: flex;
      align-items: center;
      margin-bottom: 18px;
      gap: 16px;
      justify-content: center;
    }
    .profile-img {
      width: 54px; height: 54px;
      border-radius: 50%;
      object-fit: cover;
      border: 2.5px solid #ffe48a;
      background: #191c22;
      margin-right: 6px;
    }
    .profile-info {
      text-align: left;
      font-size: 1.05rem;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .profile-info .uname {
      color: #ffe79c;
      font-family: 'Russo One', Arial, sans-serif;
      font-size: 1.18rem;
      margin-bottom: 3px;
      display: block;
      word-break: break-word;
    }
    .title {
      font-family: 'Russo One', Arial, sans-serif;
      font-size: 2.2rem;
      letter-spacing: 1.5px;
      margin-bottom: 4px;
      background: linear-gradient(90deg, #e4c05c, #ffefb0 60%, #b0a871);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: inline-block;
    }
    .roulette {
      background: #181d22;
      border: 2px solid #2f3642;
      border-radius: 18px;
      box-shadow: 0 4px 18px #0006 inset;
      margin: 18px 0 16px 0;
      padding: 20px 0 16px 0;
      position: relative;
      overflow: hidden;
      min-height: 88px;
      user-select: none;
    }
    .roulette-list {
      display: flex;
      align-items: center;
      will-change: transform;
      transition: transform 2.7s cubic-bezier(.11,.57,0,1);
    }
    .item {
      min-width: 76px;
      max-width: 76px;
      height: 76px;
      margin: 0 6px;
      background: #242d3a;
      border-radius: 13px;
      box-shadow: 0 2px 10px #0007;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border: 2px solid #222b;
      font-size: 1.5rem;
      transition: border .12s;
      position: relative;
    }
    .item.selected, .item.win {
      border-color: #ffd700;
      box-shadow: 0 0 14px 2px #ffd70055, 0 2px 10px #000a;
      z-index: 2;
    }
    .item .gift-name {
      font-size: 0.93rem;
      color: #f4d58b;
      margin-top: 7px;
      letter-spacing: .03em;
    }
    .marker {
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
      width: 0; height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 20px solid #f5cb4e;
      filter: drop-shadow(0 2px 6px #222a);
    }
    .spin-btn {
      margin-top: 20px;
      width: 90%;
      padding: 15px;
      border-radius: 16px;
      background: linear-gradient(90deg, #f5cb4e, #f9e67c 70%, #f5cb4e);
      color: #191f26;
      font-family: 'Russo One', Arial, sans-serif;
      font-size: 1.3rem;
      letter-spacing: .07em;
      border: none;
      outline: none;
      box-shadow: 0 2px 14px #0005;
      cursor: pointer;
      font-weight: 700;
      transition: background .15s, transform .09s;
      margin-bottom: 2px;
      opacity: 1;
      pointer-events: all;
    }
    .spin-btn:disabled,
    .spin-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    .spin-btn:active {
      background: #f6e5a3;
      transform: scale(.97);
    }
    .msg {
      background: #262c36;
      border-radius: 12px;
      margin: 18px 0 10px 0;
      padding: 15px 8px 13px 8px;
      font-size: 1.13rem;
      box-shadow: 0 2px 8px #0004 inset;
      line-height: 1.55;
    }
    .confirm-btn {
      background: #3ab54a;
      color: #fff;
      padding: 13px 34px;
      border-radius: 13px;
      font-size: 1.15rem;
      font-weight: 700;
      margin-top: 12px;
      border: none;
      cursor: pointer;
      transition: background .14s;
    }
    .confirm-btn:active {
      background: #278030;
    }
    .history {
      background: #242d3a;
      border-radius: 13px;
      margin-top: 24px;
      padding: 13px 10px 9px 10px;
      text-align: left;
      font-size: 0.95rem;
      color: #ccc;
      min-height: 36px;
    }
    .history h4 {
      margin: 0 0 8px 0;
      color: #e8c067;
      font-size: 1.1rem;
    }
    .history ul {
      margin: 0; padding: 0 0 0 14px;
    }
    .history li {
      margin-bottom: 2px;
      color: #eee;
    }
    .snackbar {
      position: fixed;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      min-width: 180px;
      background: #222b;
      color: #ffd767;
      font-weight: 600;
      border-radius: 14px;
      box-shadow: 0 4px 18px #0006;
      padding: 13px 34px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      font-size: 1.09rem;
      transition: opacity .18s, bottom .18s;
    }
    .snackbar.show {
      opacity: 1;
      bottom: 64px;
      pointer-events: all;
    }
    #confetti-canvas {
      pointer-events: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 9999;
      display: none;
    }
    @media (max-width: 480px) {
      .container { max-width: 99vw; margin: 12px 2vw;}
      .roulette { min-height: 72px; }
      .item { min-width: 64px; max-width: 64px; height: 64px;}
      .profile-img { width: 42px; height: 42px;}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="profile" id="profileBox" style="display:none;">
    <img class="profile-img" id="profileImg" src="" alt="User">
    <div class="profile-info">
      <span class="uname" id="profileName"></span>
      <span id="profileId"></span>
    </div>
  </div>
  <div class="title">Gift Roulette</div>
  <div class="roulette" id="roulette">
    <div class="marker"></div>
    <div class="roulette-list" id="rouletteList"></div>
  </div>
  <button class="spin-btn" id="spinBtn">–ö—Ä—É—Ç–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
  <div class="msg" id="msgBox" style="display:none"></div>
  <button class="confirm-btn" id="confirmBtn" style="display:none">–Ø –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É</button>
  <div class="history" id="historyBox">
    <h4>–ò—Å—Ç–æ—Ä–∏—è –≤—ã–∏–≥—Ä—ã—à–µ–π</h4>
    <ul id="historyList"></ul>
  </div>
</div>
<canvas id="confetti-canvas"></canvas>
<div id="snackbar" class="snackbar"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
/* ---- 1. CONFIG ---- */
// –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π firebase config:
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
// –ü—Ä–∏–∑—ã ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ
const gifts = [
  { id: 5170145012310081615, emoji: "üíñ", name: "–°–µ—Ä–¥—Ü–µ" },
  { id: 5170233102089322756, emoji: "üß∏", name: "–ü–ª—é—à–µ–≤—ã–π –º–∏—à–∫–∞" }
];

/* ---- 2. FIREBASE INIT ---- */
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---- 3. TELEGRAM AUTH ---- */
let userId = null, userName = "", userPhoto = "";
function getTelegramUser() {
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
    const tgUser = Telegram.WebApp.initDataUnsafe.user;
    userId = tgUser.id;
    userName = (tgUser.username ? ("@" + tgUser.username) : tgUser.first_name || "User");
    userPhoto = tgUser.photo_url ? tgUser.photo_url : "https://telegram.org/img/t_logo.png";
    return tgUser;
  } else {
    snackbar("–û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –∏–∑ Telegram Mini App!");
    throw "Not in Telegram Mini App";
  }
}
const tgUser = getTelegramUser();

/* ---- 4. SAVE USER IN DB (on enter) ---- */
function saveUserOnEnter() {
  if (!userId) return;
  db.ref("users/" + userId).update({
    id: userId,
    name: userName,
    photo: userPhoto,
    lastVisit: new Date().toISOString()
  });
}
saveUserOnEnter();

/* ---- 5. SHOW USER PROFILE ---- */
function showProfile() {
  if (!userId) return;
  document.getElementById('profileImg').src = userPhoto;
  document.getElementById('profileName').textContent = userName;
  document.getElementById('profileId').textContent = "ID: " + userId;
  document.getElementById('profileBox').style.display = '';
}
showProfile();

/* ---- 6. HISTORY ---- */
function loadHistory() {
  if (!userId) return;
  db.ref("users/" + userId + "/spins").once("value", snap => {
    const arr = [];
    snap.forEach(child => {
      const v = child.val();
      arr.push(`${v.time}: ${gifts.find(g=>g.id==v.gift)?.emoji||'üéÅ'} <b>${gifts.find(g=>g.id==v.gift)?.name||'–ü–æ–¥–∞—Ä–æ–∫'}</b>`);
    });
    document.getElementById('historyList').innerHTML = arr.length
      ? arr.map(x=>`<li>${x}</li>`).join('')
      : '<li>–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–∏–≥—Ä–∞–Ω–æ</li>';
  });
}
window.onload = loadHistory;

/* ---- 7. ROULETTE ---- */
const rouletteList = document.getElementById("rouletteList");
let isSpinning = false, selectedIdx = 0;

function fillRoulette(selected=-1) {
  rouletteList.innerHTML = "";
  // –ü–æ–¥–∞—Ä–∫–∏ –≤—Å–µ–≥–¥–∞ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è, –∏—Å—á–µ–∑–∞—Ç—å –Ω–µ –º–æ–≥—É—Ç
  for (let i=0; i<gifts.length*14; ++i) { // –¥–ª–∏–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
    const gift = gifts[i%gifts.length];
    const div = document.createElement("div");
    div.className = "item" + (i===selected ? " selected" : "");
    div.innerHTML = `<div style="font-size:2.2em">${gift.emoji}</div><div class="gift-name">${gift.name}</div>`;
    rouletteList.appendChild(div);
  }
}
fillRoulette();

/* ---- 8. SPIN BUTTON ---- */
document.getElementById("spinBtn").onclick = function() {
  if (isSpinning) return;
  isSpinning = true;
  this.disabled = true;
  document.getElementById('msgBox').style.display = 'none';
  document.getElementById('confirmBtn').style.display = 'none';

  // 50/50 —à–∞–Ω—Å –º–µ–∂–¥—É –¥–≤—É–º—è –ø–æ–¥–∞—Ä–∫–∞–º–∏
  const winIdx = Math.random()<0.5 ? 0 : 1;
  const spinRounds = 8 + Math.floor(Math.random()*5); // –∫–æ—Ä–æ—Ç–∫–∞—è –ª–µ–Ω—Ç–∞ = –∫—Ä—É—á–µ UX
  selectedIdx = spinRounds * gifts.length + winIdx;

  fillRoulette();
  rouletteList.style.transition = "none";
  rouletteList.style.transform = "translateX(0)";

  setTimeout(()=> {
    rouletteList.style.transition = "transform 2.7s cubic-bezier(.11,.57,0,1)";
    const width = 76+12; // item+margin*2
    const offset = selectedIdx*width - (rouletteList.parentNode.offsetWidth/2) + width/2;
    rouletteList.style.transform = `translateX(${-offset}px)`;
    setTimeout(()=>{
      isSpinning = false;
      document.getElementById("spinBtn").disabled = false;
      for (let i=0;i<rouletteList.children.length;i++) rouletteList.children[i].classList.remove('win');
      rouletteList.children[selectedIdx].classList.add('win');

      // –ö–æ–Ω—Ñ–µ—Ç—Ç–∏!
      confetti();

      // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–∏–≥—Ä—ã—à, –∑–∞–ø–∏—Å–∞—Ç—å –≤ Firebase
      const gift = gifts[winIdx];
      const msg = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ <b>${gift.emoji} ${gift.name}</b>!<br>
        –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–∑, <b>–Ω–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É <a href="https://t.me/MrFerra" target="_blank">@MrFerra</a></b>.<br>
        –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.`;
      document.getElementById('msgBox').innerHTML = msg;
      document.getElementById('msgBox').style.display = '';
      document.getElementById('confirmBtn').style.display = '';

      // –ó–∞–ø–∏—Å—å –≤ –±–∞–∑—É —é–∑–µ—Ä–∞
      const now = new Date();
      db.ref("users/"+userId).update({
        id: userId,
        name: userName,
        photo: userPhoto,
        lastSpin: now.toISOString()
      });
      db.ref("users/"+userId+"/spins").push({
        gift: gift.id,
        time: now.toLocaleString()
      });
      loadHistory();

      snackbar("üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –ø—Ä–∏–∑! –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –±–æ—Ç–æ–º");
    }, 2750);
  }, 80);
};

/* ---- 9. CONFIRM BUTTON ---- */
document.getElementById('confirmBtn').onclick = function() {
  db.ref("users/"+userId).update({
    confirmed: new Date().toISOString()
  });
  document.getElementById('msgBox').innerHTML = '–û—Ç–ª–∏—á–Ω–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–º–µ—á–µ–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞!';
  document.getElementById('confirmBtn').style.display = 'none';
  snackbar("–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞");
};

/* ---- 10. Snackbar ---- */
function snackbar(msg) {
  const sb = document.getElementById("snackbar");
  sb.textContent = msg;
  sb.className = "snackbar show";
  setTimeout(()=>sb.className="snackbar",2600);
}

/* ---- 11. –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ ---- */
function confetti() {
  const canvas = document.getElementById('confetti-canvas');
  const w = window.innerWidth, h = window.innerHeight;
  canvas.width = w; canvas.height = h;
  canvas.style.display = 'block';

  const ctx = canvas.getContext('2d');
  let confs = [];
  for (let i=0; i<90; ++i) {
    confs.push({
      x: Math.random()*w,
      y: Math.random()*-h,
      r: 6+Math.random()*9,
      d: Math.random()*90,
      color: `hsl(${Math.random()*360},80%,60%)`,
      tilt: Math.random()*15-7,
      tiltAngle: 0,
      tiltAngleIncremental: (Math.random()*0.07) + 0.05
    });
  }
  let angle = 0;
  function drawConfetti() {
    ctx.clearRect(0, 0, w, h);
    angle += 0.01;
    for (let i=0; i<confs.length; ++i) {
      let c = confs[i];
      c.y += (Math.cos(angle + c.d) + 2 + c.r/5) * 0.8;
      c.x += Math.sin(angle) * 2;
      c.tiltAngle += c.tiltAngleIncremental;
      c.tilt = Math.sin(c.tiltAngle) * 15;
      ctx.beginPath();
      ctx.lineWidth = c.r;
      ctx.strokeStyle = c.color;
      ctx.moveTo(c.x + c.tilt + c.r/3, c.y);
      ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r*1.2);
      ctx.stroke();
    }
  }
  let t = 0;
  function animate() {
    drawConfetti();
    t++;
    if (t < 85) requestAnimationFrame(animate);
    else canvas.style.display = 'none';
  }
  animate();
}
</script>
</body>
</html>
