<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Gift Roulette</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css?family=Russo+One|Montserrat:600,400&display=swap" rel="stylesheet">
  <style>
    html,body { min-height: 100vh; margin: 0; padding: 0; color: #fff; font-family: 'Montserrat',sans-serif;}
    body { background: linear-gradient(120deg, #181e24 0%, #23272f 100%); transition: background 0.33s;}
    body.light { background: linear-gradient(120deg, #fffbe9 0%, #f3eff6 100%); color:#242333;}
    .container { max-width: 430px; margin: 36px auto 0 auto; background: #212633; border-radius: 25px; box-shadow: 0 8px 32px #000a;
      padding: 37px 18px 24px 18px; text-align: center; position: relative; overflow: visible; }
    body.light .container {background: #f6f2d4; color:#232232; box-shadow:0 6px 24px #0001;}
    .tabcontent { display: none; min-height: 56vh;}
    .tabcontent.active { display: block; animation:fadein .36s;}
    @keyframes fadein { from{ opacity:0; transform: translateY(22px);} to{ opacity:1; transform:none;} }
    .tabbar { position: fixed; left:0; bottom:0; width:100vw; background:#222940d9;
      display: flex; z-index: 20; height:78px; border-top:1.7px solid #332e48;
      box-shadow:0 0 28px #0008; backdrop-filter: blur(8px); justify-content: space-around; align-items: center; }
    .tabbtn { flex:1; text-align:center; font-size:1.18em; color:#bbb; display: flex; flex-direction: column; align-items: center; justify-content: center; height:77px;
      cursor:pointer; border:none; background:none; transition:.18s; font-family:'Russo One',sans-serif; letter-spacing:.01em;}
    .tabbtn.active { color:#ffd700;}
    .tabbtn svg { font-size:2em; width:2em; height:2em; margin-bottom:3px;}
    .section-title { font-family:'Russo One',Arial,sans-serif; font-size:2.15em; margin-bottom:16px; display:flex; align-items:center; justify-content:center; gap:11px;}
    .section-title svg {width:1.35em; height:1.35em;}
    .profile { display: flex; flex-direction: column; align-items: center; gap: 9px; margin-bottom: 18px;}
    .profile-img { width: 66px; height: 66px; border-radius: 50%; object-fit: cover; border: 3px solid #ffe48a; background: #191c22;}
    .profile-info { text-align: center; font-size: 1.15rem;}
    .profile-info .uname { color: #2b93f8; background: #eaf6ff; padding:3px 14px 3px 14px; border-radius:16px; display:inline-block; font-family:'Russo One'; font-size:1.08em;}
    body.light .profile-info .uname { color:#1e63b0; background:#d4e9fc;}
    .profile-row {display:flex; justify-content:center;align-items:center;gap:10px;margin:8px 0;}
    .badge {display:inline-block; background:#ffd700; color:#23262d; font-weight:800; font-size:.98em; border-radius:11px; padding:4px 14px 4px 13px; margin-left:7px;}
    .theme-btn {margin:9px auto 0 auto; padding:9px 28px; border-radius:12px; background:#242d3a; color:#ffd700; font-size:1em; border:none; cursor:pointer; font-family:'Russo One'; transition:.18s;}
    body.light .theme-btn {background:#ffe7ae; color:#242d3a;}
    .streak {margin:14px 0 0 0; color:#47e784; font-weight:600; font-size:1em;}
    .tip {margin-top:18px; color:#a9e1ff; font-size:.98em;}
    .roulette { background: #181d22; border: 2.2px solid #2f3642; border-radius: 25px; box-shadow: 0 4px 18px #0006 inset;
      margin: 22px auto 16px auto; padding: 34px 0 38px 0; position: relative; overflow: hidden; min-height: 170px; width:100%; max-width:520px; user-select: none;}
    body.light .roulette {background:#fdfae8; border-color:#f2e4ad;}
    .roulette-list { display: flex; will-change: transform; align-items: center;}
    .item { min-width: 110px; max-width: 110px; height: 112px; margin: 0 13px; background: #242d3a; border-radius: 19px;
      box-shadow: 0 2px 18px #0007; display: flex; flex-direction: column; justify-content: center; align-items: center;
      border: 2px solid #222b; font-size: 2.2rem; transition: border .14s,box-shadow .18s,transform .19s;}
    .item.emoji-bounce { animation:bounceEm .75s cubic-bezier(.65,.2,.39,1.7);}
    @keyframes bounceEm { 0%{transform:scale(1);} 60%{transform:scale(1.19);} 80%{transform:scale(0.95);} 100%{transform:scale(1);} }
    .item.selected, .item.win { border-color: #ffd700; box-shadow: 0 0 28px 6px #ffd70077, 0 2px 10px #000a; z-index: 2;}
    .item.win { animation:winGlow 0.85s;}
    @keyframes winGlow {0%{box-shadow:0 0 0 0 #ffd700;} 100%{box-shadow:0 0 28px 6px #ffd70077;} }
    .item .gift-name { font-size: 1.24rem; color: #f4d58b; margin-top: 11px; letter-spacing: .03em;}
    .marker { position: absolute; top: 8px; left: 50%; transform: translateX(-50%); z-index: 2; width: 0; height: 0;
      border-left: 24px solid transparent; border-right: 24px solid transparent; border-bottom: 36px solid #f5cb4e;
      filter: drop-shadow(0 2px 6px #222a);}
    .spin-btn { margin-top: 28px; width: 95%; padding: 22px; border-radius: 22px;
      background: linear-gradient(90deg, #f5cb4e, #f9e67c 70%, #f5cb4e); color: #191f26;
      font-family: 'Russo One', Arial, sans-serif; font-size: 1.67rem; letter-spacing: .09em;
      border: none; outline: none; box-shadow: 0 2px 18px #0005; cursor: pointer; font-weight: 700;
      transition: background .15s, transform .09s;}
    .spin-btn:active, .spin-btn:focus { animation: btnBounce .22s;}
    @keyframes btnBounce {0%{transform:scale(1);}60%{transform:scale(1.13);}100%{transform:scale(1);} }
    .spin-btn:disabled { background: #f6e5a3; transform: scale(.98); opacity: 0.8; cursor: not-allowed;}
    .msg-helper {margin:0 0 10px 0; color:#ffe788; font-size:1.12em; font-weight:500;}
    .msg-helper .botname {color:#54bbff; font-weight:800; cursor:pointer; padding:0 3px; text-decoration:underline;}
    .msg { background: #262c36; border-radius: 13px; margin: 19px 0 13px 0; padding: 18px 8px 16px 8px;
      font-size: 1.17rem; box-shadow: 0 2px 8px #0004 inset; line-height: 1.55; min-height: 60px; display: none;}
    .msg.visible { display: block; }
    .confirm-btn { background: #3ab54a; color: #fff; padding: 19px 43px; border-radius: 16px; font-size: 1.22rem;
      font-weight: 700; margin-top: 17px; border: none; cursor: pointer; transition: background .14s; display: none;}
    .confirm-btn:active { background: #278030; }
    .confirm-btn.visible { display: inline-block; }
    .status-wait {margin-top:18px; margin-bottom:10px;}
    .status-dot {display:inline-block; width:16px; height:16px; border-radius:50%; background:#ffd700;
      box-shadow:0 0 18px #ffd70066; vertical-align:middle; margin-right:8px; animation:statspin 1.2s infinite;}
    @keyframes statspin {0%{box-shadow:0 0 7px #ffd70077;}50%{box-shadow:0 0 18px #ffd700;}100%{box-shadow:0 0 7px #ffd70077;} }
    .history-list { margin:0; padding:0; display:flex; flex-direction:column; gap:13px;}
    .history-card { background:#23273d; border-radius:13px; padding:13px 18px; display:flex; align-items:center; gap:13px;
      box-shadow:0 2px 10px #0005; }
    .history-emoji {font-size:2.2em; margin-right:12px;}
    .history-info { flex:1;}
    .history-date { color:#ffd46b; font-size:0.98em;}
    .history-status { font-size:1em; font-weight:700;}
    .hstatus-await { color:#e0b100;}
    .hstatus-done { color:#47e784;}
    .hstatus-none { color:#aaa;}
    .filters {display:flex; gap:12px; margin:0 0 13px 0;}
    .filter-btn {padding:8px 16px; border-radius:9px; border:none; background:#23283b; color:#fff; font-size:1.05em;
      cursor:pointer; transition:.11s;}
    .filter-btn.active {background:#ffd700; color:#23262d;}
    .snackbar { visibility: hidden; min-width: 180px; background: #242d3a; color: #fff; text-align: center;
      border-radius: 11px; padding: 13px 22px; position: fixed; z-index: 99; left: 50%; bottom: 40px; transform: translateX(-50%);
      font-size: 1rem; box-shadow: 0 2px 14px #0007; transition: visibility 0s, opacity .35s cubic-bezier(.4,.01,0,1), bottom .23s;
      opacity: 0; pointer-events: none;}
    .snackbar.show { visibility: visible; opacity: 1; pointer-events: auto; bottom: 65px;}
    .modal-bg { position:fixed; left:0;top:0;right:0;bottom:0;background:#222940e9;z-index:99;display:none;align-items:center;justify-content:center;}
    .modal-bg.active {display:flex;}
    .modal {background:#23264a;padding:33px 20px 36px 20px; border-radius:25px; box-shadow:0 12px 38px #0009; text-align:center;}
    body.light .modal {background:#f9efb3;}
    .modal-win {font-size:1.37em; color:#ffd700; margin-bottom:13px; font-weight:700;}
    .modal-emoji {font-size:3.8em; margin-bottom:10px; animation:winBounce 1.1s;}
    @keyframes winBounce {0%{transform:scale(1);}50%{transform:scale(1.55);}70%{transform:scale(0.93);}100%{transform:scale(1);} }
    .modal-btn, .modal-msg-btn { margin-top:22px; background:#ffd700; color:#181e24; padding:15px 42px; border-radius:15px; border:none; font-size:1.09em; font-weight:700; cursor:pointer;}
    .modal-btn:active, .modal-msg-btn:active {background:#ffe47b;}
    .modal-msg-btn {background:#54bbff;color:#fff;margin-right:9px;}
    .confetti { position: fixed; pointer-events: none; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 120; overflow: hidden; pointer-events: none;}
    @media (max-width: 540px) {
      .container { max-width: 100vw; margin: 4px 0 0 0;}
      .roulette {min-height:110px; max-width:98vw;}
      .item{min-width:70px;max-width:70px;height:70px;}
      .marker{border-left:13px solid transparent;border-right:13px solid transparent;border-bottom:23px solid #f5cb4e;}
      .spin-btn{font-size:1.11em;}
      .profile-img{width:40px;height:40px;}
      .modal{padding:21px 7vw 21px 7vw;}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="tabcontent tab-roulette active" id="tab-roulette">
    <div class="section-title"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Рулетка</div>
    <div class="roulette" id="roulette">
      <div class="marker"></div>
      <div class="roulette-list" id="rouletteList"></div>
    </div>
    <div class="msg-helper">Чтобы получить приз, <span class="botname" id="botName">@MrFerra</span> — напишите любое сообщение ему</div>
    <button class="spin-btn" id="spinBtn">Крутить бесплатно</button>
    <div class="msg" id="msgBox"></div>
    <button class="confirm-btn" id="confirmBtn">Я отправил, жду подарок</button>
  </div>
  <div class="tabcontent tab-history" id="tab-history">
    <div class="section-title"><svg width="1.7em" height="1.7em" viewBox="0 0 24 24" fill="none"><rect x="4" y="7" width="16" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path d="M8 3h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 3v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>Мои выигрыши</div>
    <div class="filters">
      <button class="filter-btn active" id="filterAll">Все</button>
      <button class="filter-btn" id="filterNotClaimed">Не полученные</button>
      <button class="filter-btn" id="filterClaimed">Полученные</button>
    </div>
    <div id="historyCards"></div>
  </div>
  <div class="tabcontent tab-profile" id="tab-profile">
    <div class="section-title"><svg width="1.7em" height="1.7em" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="9" r="4" stroke="currentColor" stroke-width="2"/><path d="M4 21v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2"/></svg>Профиль</div>
    <div class="profile" id="profileBox">
      <img class="profile-img" id="profileImg" src="" alt="User">
      <div class="profile-info">
        <span class="uname" id="profileName"></span>
        <div style="margin:5px 0 3px 0;"><span id="profileId"></span> <span id="badgeLucky"></span></div>
      </div>
      <div id="streakVal" class="streak"></div>
      <button class="theme-btn" id="themeBtn">Изменить тему</button>
      <div id="tip" class="tip"></div>
      <button class="theme-btn" style="background:#f57485;color:#fff;margin-top:18px;" onclick="logout()">Выйти</button>
    </div>
  </div>
  <div class="tabbar">
    <button class="tabbtn active" data-tab="tab-roulette">
      <svg width="1.7em" height="1.7em" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>Рулетка</span>
    </button>
    <button class="tabbtn" data-tab="tab-history">
      <svg width="1.7em" height="1.7em" viewBox="0 0 24 24" fill="none"><rect x="4" y="7" width="16" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path d="M8 3h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 3v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      <span>Выигрыши</span>
    </button>
    <button class="tabbtn" data-tab="tab-profile">
      <svg width="1.7em" height="1.7em" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="9" r="4" stroke="currentColor" stroke-width="2"/><path d="M4 21v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2"/></svg>
      <span>Профиль</span>
    </button>
  </div>
</div>
<div class="snackbar" id="snackbar"></div>
<div class="modal-bg" id="modalBg">
  <div class="modal" id="winModal">
    <div class="modal-emoji" id="modalEmoji">🎁</div>
    <div class="modal-win" id="modalWinText">Поздравляем!<br>Вы выиграли приз!</div>
    <button class="modal-msg-btn" id="modalMsgBtn">Написать боту</button>
    <button class="modal-btn" id="closeModalBtn">Готово</button>
  </div>
</div>
<canvas class="confetti" id="confetti"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
/* ---- 1. CONFIG ---- */
const firebaseConfig = {
  apiKey: "AIzaSyDX8BiSqlghdgOj4_zPSyPgATfHVV5DNQI",
  authDomain: "gifts-d8f30.firebaseapp.com",
  projectId: "gifts-d8f30",
  storageBucket: "gifts-d8f30.firebasestorage.app",
  messagingSenderId: "883903383261",
  appId: "1:883903383261:web:dad1742c009ea38bf5fd34",
  measurementId: "G-5JFXH4YG3J"
};
const gifts = [
  { id: 5170145012310081615, emoji: "💖", name: "Сердце" },
  { id: 5170233102089322756, emoji: "🧸", name: "Плюшевый мишка" }
];

/* ---- 2. FIREBASE INIT ---- */
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---- 3. TELEGRAM AUTH ---- */
let userId = null, userName = "", userPhoto = "";
function getTelegramUser() {
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
    const tgUser = Telegram.WebApp.initDataUnsafe.user;
    userId = tgUser.id;
    userName = (tgUser.username ? ("@" + tgUser.username) : tgUser.first_name || "User");
    userPhoto = tgUser.photo_url ? tgUser.photo_url : "https://telegram.org/img/t_logo.png";
    return tgUser;
  } else {
    showSnackbar("Откройте сайт из Telegram Mini App!");
    throw "Not in Telegram Mini App";
  }
}
getTelegramUser();

/* ---- 4. PROFILE ---- */
function showProfile() {
  if (!userId) return;
  document.getElementById('profileImg').src = userPhoto;
  document.getElementById('profileName').textContent = userName;
  document.getElementById('profileId').textContent = "ID: " + userId;
  // "Удачливый" бейджик и стрик
  db.ref("users/" + userId + "/spins").once("value", snap => {
    let total = 0, streak = 0, maxStreak = 0, prevGift = null;
    snap.forEach(child=>{
      total++;
      const v=child.val();
      if (v.gift === prevGift) streak++; else streak=1;
      if (streak>maxStreak) maxStreak=streak;
      prevGift = v.gift;
    });
    document.getElementById("badgeLucky").innerHTML = (total>=5?'<span class="badge">Удачливый</span>':'');
    document.getElementById("streakVal").innerHTML = (maxStreak>=2?`Стрик призов подряд: <b>${maxStreak}</b>`:'');
  });
  // Подсказка дня
  const tips=[
    "Совет: Призы выдаются мгновенно после сообщения боту.",
    "Факт: Чем чаще играете, тем выше шанс стать Удачливым!",
    "Лайфхак: Используйте мобильное приложение Telegram для удобства.",
    "Знаете? Можно делиться выигрышами с друзьями!",
    "Только у нас: честный 50/50 шанс!"
  ];
  document.getElementById("tip").textContent = tips[Math.floor(Math.random()*tips.length)];
}
showProfile();

/* ---- 5. NAVIGATION ---- */
const tabs = ["tab-roulette","tab-history","tab-profile"];
let curTab = 0;
document.querySelectorAll(".tabbtn").forEach((btn, idx) => {
  btn.onclick = ()=>{
    switchTab(idx);
  }
});
function switchTab(idx){
  tabs.forEach((tab,i)=> {
    document.getElementById(tab).classList.toggle("active",i===idx);
    document.querySelectorAll(".tabbtn")[i].classList.toggle("active",i===idx);
  });
  curTab = idx;
  if(idx===1) loadHistoryCards();
  if(idx===2) showProfile();
}
let touchStartX=null;
window.addEventListener("touchstart",e=>{
  if(e.touches.length==1) touchStartX = e.touches[0].clientX;
});
window.addEventListener("touchend",e=>{
  if(touchStartX==null) return;
  let dx = e.changedTouches[0].clientX - touchStartX;
  if(Math.abs(dx)>70){
    if(dx<0 && curTab<tabs.length-1) switchTab(curTab+1);
    if(dx>0 && curTab>0) switchTab(curTab-1);
  }
  touchStartX=null;
});

/* ---- 6. РУЛЕТКА ---- */
const rouletteList = document.getElementById("rouletteList");
let isSpinning = false, selectedIdx = 0, slots = [];
function shuffle(arr) {
  let a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function fillRoulette(selectedCenter=-1) {
  slots = [];
  let l = 23; // всегда нечетное, чтобы win был точно по центру
  let cycle = shuffle(gifts);
  let k = 0;
  for (let i=0; i<l; ++i) {
    slots.push(cycle[k]);
    k++;
    if (k>=cycle.length) { cycle = shuffle(gifts); k=0; }
  }
  rouletteList.innerHTML = "";
  for (let i=0; i<slots.length; ++i) {
    const gift = slots[i];
    const div = document.createElement("div");
    div.className = "item" + (i===selectedCenter ? " selected" : "");
    div.innerHTML = `<div class="roulette-emoji">${gift.emoji}</div><div class="gift-name">${gift.name}</div>`;
    rouletteList.appendChild(div);
  }
}

/* ---- 7. SPIN BUTTON ---- */
document.getElementById("spinBtn").onclick = function() {
  if (isSpinning) return;
  isSpinning = true;
  document.getElementById('msgBox').classList.remove('visible');
  document.getElementById('confirmBtn').classList.remove('visible');
  fillRoulette();
  // Выигрыш всегда строго по центру
  const centerIdx = Math.floor(slots.length/2);
  const winGift = gifts[Math.random()<0.5?0:1];
  slots[centerIdx] = winGift; // строго по центру выигрышный
  // Еще раз рандомим соседей чтобы не было понятно что всегда в центре winGift
  for(let j=1;j<=4;j++) {
    let swapIdx = centerIdx+j;
    let randomGift = gifts[Math.floor(Math.random()*gifts.length)];
    slots[swapIdx]=randomGift;
    slots[centerIdx-j]=gifts[Math.floor(Math.random()*gifts.length)];
  }
  rouletteList.innerHTML = "";
  for (let i=0; i<slots.length; ++i) {
    const gift = slots[i];
    const div = document.createElement("div");
    div.className = "item" + (i===centerIdx ? " selected" : "");
    div.innerHTML = `<div class="roulette-emoji">${gift.emoji}</div><div class="gift-name">${gift.name}</div>`;
    rouletteList.appendChild(div);
  }
  rouletteList.style.transition = "none";
  rouletteList.style.transform = "translateX(0)";
  setTimeout(()=> {
    rouletteList.style.transition = "transform 2.2s cubic-bezier(.11,.57,0,1)";
    const width = 110+26;
    const offset = centerIdx*width - (rouletteList.parentNode.offsetWidth/2) + width/2;
    rouletteList.style.transform = `translateX(${-offset}px)`;
    setTimeout(()=>{
      isSpinning = false;
      document.getElementById("spinBtn").disabled = false;
      for (let i=0;i<rouletteList.children.length;i++) {
        rouletteList.children[i].classList.remove('win');
        rouletteList.children[i].classList.remove('emoji-bounce');
      }
      const winElem = rouletteList.children[centerIdx];
      winElem.classList.add('win');
      winElem.classList.add('emoji-bounce');
      showWinModal(slots[centerIdx]);
      // Запись в базу
      const now = new Date();
      db.ref("users/"+userId).update({
        id: userId,
        name: userName,
        photo: userPhoto,
        lastSpin: now.toISOString()
      });
      db.ref("users/"+userId+"/spins").push({
        gift: slots[centerIdx].id,
        time: now.toLocaleString(),
        status: "not_claimed"
      });
      loadHistoryCards();
      confettiEffect();
    }, 2200);
  }, 80);
  document.getElementById("spinBtn").disabled = true;
  setTimeout(()=>{document.getElementById("spinBtn").disabled = false;}, 3200);
};

/* ---- 8. WIN MODAL ---- */
function showWinModal(gift) {
  document.getElementById("modalEmoji").textContent = gift.emoji;
  document.getElementById("modalWinText").innerHTML = `Поздравляем!<br>Вы выиграли <b>${gift.emoji} ${gift.name}</b>`;
  document.getElementById("modalBg").classList.add("active");
}
document.getElementById("modalMsgBtn").onclick = function(){
  window.open('https://t.me/MrFerra','_blank');
};
document.getElementById("botName").onclick = function(){
  window.open('https://t.me/MrFerra','_blank');
};
document.getElementById("closeModalBtn").onclick = function(){
  document.getElementById("modalBg").classList.remove("active");
  document.getElementById('msgBox').innerHTML = `<span style="font-size:1.13em;color:#ffe57c;">Чтобы получить приз, <b>напишите любое сообщение <a href="https://t.me/MrFerra" target="_blank">@MrFerra</a></b>.<br><span style="color:#aaa;font-size:0.98em;">После этого нажмите кнопку ниже.</span>`;
  document.getElementById('msgBox').classList.add('visible');
  document.getElementById('confirmBtn').classList.add('visible');
};

/* ---- 9. CONFIRM BUTTON ---- */
document.getElementById('confirmBtn').onclick = function() {
  db.ref("users/"+userId).update({
    confirmed: new Date().toISOString()
  });
  document.getElementById('msgBox').innerHTML = `
    <div class="status-wait"><span class="status-dot"></span>Ожидаем подтверждения выдачи подарка...</div>
    <div style="color:#aaa;font-size:1.04em;">Бот проверит сообщение и автоматически обновит статус.</div>
  `;
  document.getElementById('confirmBtn').classList.remove('visible');
  listenForDelivered();
};

/* ---- 10. АВТООБНОВЛЕНИЕ СТАТУСА ---- */
let deliveredListener = null;
function listenForDelivered() {
  if(deliveredListener) deliveredListener.off();
  deliveredListener = db.ref("users/"+userId+"/spins");
  deliveredListener.on("value", snap => {
    let anyDelivered = false;
    snap.forEach(child=>{
      const v = child.val();
      if(v.status==="delivered") anyDelivered=true;
    });
    if(anyDelivered) {
      document.getElementById('msgBox').innerHTML = `<span style="font-size:1.18em;color:#ffd700;">Поздравляем!</span><br>Ваш подарок успешно выдан!`;
      loadHistoryCards();
      if(deliveredListener) deliveredListener.off();
    }
  });
}

/* ---- 11. ИСТОРИЯ ---- */
let historyFilter = "all";
document.getElementById("filterAll").onclick = ()=>{ setHistoryFilter("all"); };
document.getElementById("filterNotClaimed").onclick = ()=>{ setHistoryFilter("not_claimed"); };
document.getElementById("filterClaimed").onclick = ()=>{ setHistoryFilter("delivered"); };
function setHistoryFilter(f){
  historyFilter = f;
  document.getElementById("filterAll").classList.toggle("active",f==="all");
  document.getElementById("filterNotClaimed").classList.toggle("active",f==="not_claimed");
  document.getElementById("filterClaimed").classList.toggle("active",f==="delivered");
  loadHistoryCards();
}
function loadHistoryCards() {
  if (!userId) return;
  db.ref("users/" + userId + "/spins").once("value", snap => {
    const arr = [];
    snap.forEach(child => {
      const v = child.val();
      if(historyFilter==="all" || v.status===historyFilter) {
        arr.push({...v, key:child.key});
      }
    });
    arr.reverse();
    let html = arr.length
      ? arr.map(v=>{
        const g=gifts.find(g=>g.id==v.gift);
        let statusTxt = "Не получен", statusClass = "hstatus-none";
        if(v.status==="not_claimed") statusTxt = "Ожидает подтверждения", statusClass = "hstatus-await";
        if(v.status==="delivered") statusTxt = "Получен", statusClass = "hstatus-done";
        return `
        <div class="history-card">
          <span class="history-emoji">${g?g.emoji:'🎁'}</span>
          <div class="history-info">
            <div style="font-size:1.13em;font-weight:700;">${g?g.name:'Подарок'}</div>
            <div class="history-date">${v.time||''}</div>
          </div>
          <span class="history-status ${statusClass}">${statusTxt}</span>
        </div>`;
      }).join('')
      : '<div style="padding:22px;text-align:center;color:#999;">Вы ещё ничего не выиграли</div>';
    document.getElementById("historyCards").innerHTML = `<div class="history-list">${html}</div>`;
  });
}

/* ---- 12. ТЕМА ---- */
document.getElementById("themeBtn").onclick = function(){
  if(document.body.classList.contains("light")){
    document.body.classList.remove("light");
    localStorage.setItem("theme","dark");
  }else{
    document.body.classList.add("light");
    localStorage.setItem("theme","light");
  }
};
if(localStorage.getItem("theme")==="light"){
  document.body.classList.add("light");
}

/* ---- 13. SNACKBAR ---- */
function showSnackbar(msg, time=2800) {
  let sb = document.getElementById('snackbar');
  sb.textContent = msg;
  sb.className = "snackbar show";
  setTimeout(()=>{ sb.className = "snackbar"; }, time);
}

/* ---- 14. CONFETTI ---- */
function confettiEffect() {
  const colors = ["#ffd700", "#ff69b4", "#00e0ca", "#ffe579", "#f68c47", "#74dbef", "#f54555"];
  const canvas = document.getElementById("confetti");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  let pieces = [];
  for (let i = 0; i < 110; i++) {
    pieces.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height * 0.1,
      w: 7 + Math.random() * 8,
      h: 16 + Math.random() * 6,
      angle: Math.random() * 2 * Math.PI,
      color: colors[Math.floor(Math.random() * colors.length)],
      vy: 2 + Math.random() * 3,
      vx: (Math.random() - 0.5) * 2.5,
      va: (Math.random() - 0.5) * 0.08
    });
  }
  let frames = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let p of pieces) {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.angle);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
      p.x += p.vx;
      p.y += p.vy;
      p.angle += p.va;
      if (p.y > canvas.height) p.y = -20, p.x = Math.random()*canvas.width;
    }
    frames++;
    if (frames < 85) requestAnimationFrame(draw);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  draw();
}

/* ---- 15. LOGOUT MOCK ---- */
function logout(){
  showSnackbar("Выход из аккаунта... (это прототип)", 2000);
}

fillRoulette();
loadHistoryCards();
</script>
</body>
</html>

