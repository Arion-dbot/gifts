<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Gift Roulette — TMA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <link href="https://fonts.googleapis.com/css?family=Russo+One|Montserrat:700,600,400&display=swap" rel="stylesheet">
  <style>
    html,body {
      background: linear-gradient(120deg, #181e24 0%, #23272f 100%);
      min-height: 100vh;
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0; padding: 0;
      color: #fff;
      font-size: 18px;
    }
    #app { min-height: 100vh;}
    /* -------- SPLASH / TUTORIAL -------- */
    .splash {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100vh; width: 100vw; position: fixed; z-index: 99; top:0; left:0; background: #181e24;
      animation: fadein .7s cubic-bezier(.2,.75,.23,1);
      transition: opacity .4s;
    }
    .splash.hide { opacity:0; pointer-events: none;}
    .splash-logo { font-size: 3.5rem; margin-bottom: 15px; animation: tada .9s .2s;}
    .splash-title { font-family: 'Russo One'; font-size: 2.1rem; margin-bottom: 7px; letter-spacing: .05em; }
    .splash-desc { color: #ffe47a; font-size: 1.13rem; margin-bottom: 29px;}
    .splash-btn, .tutorial-btn {
      background: linear-gradient(90deg, #ffe47a, #ffc03e 70%, #ffe47a); color: #181e24; font-weight: 700;
      font-size: 1.21rem; padding: 13px 42px; border-radius: 22px; border: none; box-shadow: 0 2px 12px #0005;
      cursor: pointer; transition: .12s; font-family: 'Russo One'; letter-spacing: .08em;
      margin-top: 15px;
    }
    .splash-btn:active, .tutorial-btn:active { background: #ffe7ac;}
    .tutorial-step { display: none; flex-direction: column; align-items: center; }
    .tutorial-step.active { display: flex; animation: fadein .46s;}
    .tutorial-ic { font-size: 2.9em; margin-bottom: 8px; }
    .tutorial-title { font-size: 1.26em; font-weight: 800; color: #ffe47a; margin-bottom: 10px;}
    .tutorial-desc { font-size: 1.09em; color: #fff; margin-bottom: 14px; text-align: center; line-height: 1.4;}
    /* -------- TABBAR -------- */
    .tabbar {
      position: fixed; left: 0; bottom: 22px; width: 100vw; z-index: 22; background: #1e232b;
      display: flex; justify-content: space-around; border-radius: 18px 18px 18px 18px;
      box-shadow: 0 0 24px #0008, 0 1.5px 24px #fff1 inset;
      max-width: 420px; margin: 0 auto; left: 50%; transform: translateX(-50%);
      border: 2px solid #282c37;
      padding: 3px 0 0 0;
      animation: fadein .7s;
    }
    .tab-btn {
      flex: 1; display: flex; flex-direction: column; align-items: center; padding: 14px 0 7px 0;
      color: #bbb; font-size: 1.14rem; font-weight: 700; letter-spacing: .02em; cursor: pointer;
      outline: none; border: none; background: none; transition: color .13s, text-shadow .14s;
      font-family: 'Montserrat'; user-select: none; min-width: 70px; position: relative;
    }
    .tab-btn.active {
      color: #ffd700; text-shadow: 0 0 7px #ffe47a55, 0 0 12px #fff3;
    }
    .tab-btn-ic { font-size: 2.15em; line-height: 1;}
    .tab-btn.active:after {
      content: ""; display: block; position: absolute; left: 50%; bottom: -2px;
      transform: translateX(-50%); width: 44%; height: 6px; border-radius: 7px;
      background: linear-gradient(90deg, #fffacd 0%, #ffd700 60%, #fffacd 100%);
      filter: blur(2px); opacity: .7; box-shadow: 0 0 10px #fff0;
    }
    /* -------- MAIN SECTIONS -------- */
    .main-section { display: none; padding-bottom: 84px; }
    .main-section.active { display: block; animation: fadein .65s; }
    .container { max-width: 430px; margin: 42px auto 0 auto; background: #212633; border-radius: 27px;
      box-shadow: 0 7px 34px #000b, 0 4px 42px #ffd70008 inset; padding: 40px 14px 22px 14px; text-align: center;}
    /* --------- РУЛЕТКА --------- */
    .roulette-block { padding-bottom: 26px;}
    .title { font-family: 'Russo One', Arial, sans-serif; font-size: 2.1rem; letter-spacing: 1.5px; margin-bottom: 22px;
      background: linear-gradient(90deg, #e4c05c, #ffefb0 60%, #b0a871); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block;}
    .roulette-wrap {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      margin-bottom: 17px; 
    }
    .roulette {
      background: linear-gradient(120deg,#22293d 75%,#272a33 100%);
      border: 4px solid #252d39;
      border-radius: 38px;
      box-shadow: 0 5px 32px #000c,0 2px 40px #ffd70015 inset;
      margin: 0 auto 2px auto;
      padding: 28px 0 18px 0;
      position: relative; overflow: hidden; min-height: 176px;
      user-select: none;
      max-width: 95vw;
      width: 368px;
      display: flex; justify-content: center; align-items: center;
    }
    .roulette-list { display: flex; will-change: transform; align-items: center; height: 140px;}
    .marker {
      position: absolute; top: 6px; left: 50%; transform: translateX(-50%);
      z-index: 3; width: 0; height: 0;
      border-left: 23px solid transparent;
      border-right: 23px solid transparent;
      border-bottom: 29px solid #ffe268;
      filter: drop-shadow(0 2px 7px #222a);
    }
    .item {
      min-width: 108px; max-width: 108px; height: 144px; margin: 0 11px;
      background: linear-gradient(160deg, #2a3140 70%, #23293b 100%);
      border-radius: 23px; box-shadow: 0 5px 18px #000a,0 0 0 3px #ffd70066;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      border: 3px solid #2e3450;
      font-size: 2.3rem; position: relative; transition: box-shadow .21s, border .19s, transform .19s, opacity .17s;
      z-index: 2;
    }
    .item .gift-emoji {
      font-size: 3.5em; position: relative; top: -4px; z-index:3;
      text-shadow: 0 5px 18px #ffd70033, 0 2px 14px #000b;
      animation: emojiBounce 1.7s infinite alternate cubic-bezier(.4,.9,.36,1);
    }
    .item .gift-name {
      font-size: 1.16rem; color: #f4d58b; margin-top: 16px; letter-spacing: .03em;
      font-family: 'Russo One'; font-weight: 700; text-shadow:0 2px 12px #0002;
    }
    .item.selected, .item.win {
      border-color: #ffd700;
      box-shadow: 0 0 0 6px #ffd70044, 0 0 34px #ffd700a8, 0 5px 18px #000b;
      animation: giftbounce .95s cubic-bezier(.23,1.2,.23,1), winshadow .92s cubic-bezier(.26,1.2,.23,1);
      transform: scale(1.14) rotate(-1.8deg);
    }
    .item.lost { opacity:.5; }
    .item.selected::after, .item.win::after {
      content:""; display:block; position:absolute;left:8px;top:8px;width:92px;height:120px; border-radius:20px;
      box-shadow: 0 0 20px 7px #fff2;
      background: radial-gradient(ellipse at 50% 30%, #fff9 12%, #fff0 65%);
      pointer-events:none; z-index:4; animation: winshine .8s;
    }
    /* Background texture */
    .item::before {
      content:""; position:absolute;left:0;top:0;width:100%;height:100%;z-index:1; border-radius:22px;
      background: url("https://www.transparenttextures.com/patterns/cubes.png");
      opacity:.09;
    }
    /* -------- BUTTONS -------- */
    .spin-btn {
      margin: 20px auto 0 auto; width: 96%; padding: 19px; border-radius: 23px; background: linear-gradient(90deg, #ffe268, #ffd700 60%, #fffacd 100%);
      color: #191f26; font-family: 'Russo One', Arial, sans-serif; font-size: 1.32rem; letter-spacing: .08em; border: none; outline: none;
      box-shadow: 0 3px 20px #ffd70055, 0 3px 24px #0005;
      cursor: pointer; font-weight: 900; margin-bottom: 2px; transition: background .15s, transform .16s;
      animation: btnpulse 2.5s infinite alternate;
    }
    .spin-btn:active { background: #ffe18c; transform: scale(.96);}
    .spin-btn:disabled { background: #ffe18c; opacity: .75; cursor: not-allowed;}
    /* -------- MODAL -------- */
    .modal-bg {
      display:none; position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:222;background:#181e24cc;
      align-items:center;justify-content:center;}
    .modal-bg.active { display:flex; animation: fadein .24s;}
    .modal {
      background: #23283b; border-radius: 23px; box-shadow: 0 6px 55px #000e, 0 0 18px #ffd70020;
      padding: 34px 26px 32px 26px; max-width: 360px; width:95vw; text-align: center; color: #fff; position:relative;
      animation: modalpop .21s cubic-bezier(.22,1.2,.23,1);}
    .modal .big-emoji { font-size: 5.1em; margin-bottom: 15px; animation: tada .68s;}
    .modal-title { font-size: 1.38em; font-family:'Russo One'; color:#ffe37a; margin-bottom:8px;}
    .modal-desc {font-size:1.15em;}
    .modal-btn { background: linear-gradient(90deg, #ffe47a, #ffc03e 70%, #ffe47a); color: #181e24; font-weight: 800; font-size: 1.13rem;
      padding: 13px 44px; border-radius: 15px; border: none; cursor: pointer; margin-top: 21px;}
    .modal-btn:active { background: #ffe7ac;}
    .msg { background: #262c36; border-radius: 12px; margin: 20px 0 14px 0; padding: 19px 12px 19px 12px; font-size: 1.12rem;
      box-shadow: 0 2px 8px #0004 inset; line-height: 1.57; min-height: 68px; display: none;}
    .msg.visible { display: block; animation: fadein .38s;}
    .confirm-btn {
      background: #4dbe2a; color: #fff; padding: 15px 46px; border-radius: 15px; font-size: 1.18rem; font-weight: 800; margin-top: 19px;
      border: none; cursor: pointer; transition: background .13s, transform .13s; display: none;
      box-shadow:0 2px 14px #1b820622;
    }
    .confirm-btn:active { background: #278030;}
    .confirm-btn.visible { display: inline-block; }
    .wait-status { margin-top: 15px; color: #eee; font-size: 1.15em; }
    .wait-dot { display: inline-block; animation: blink 1.1s infinite;}
    /* -------- HISTORY -------- */
    .history {
      background: #242c3e; border-radius: 15px; margin: 30px 0 0 0; padding: 16px 13px 14px 13px; text-align: left; font-size: 1.07rem;
      color: #ccc; min-height: 60px; box-shadow:0 3px 18px #0007;
    }
    .history h4 { margin: 0 0 14px 0; color: #ffe37a; font-size: 1.14rem;}
    .history-cards { display: flex; flex-direction: column; gap: 15px;}
    .history-card { background: linear-gradient(120deg,#22293d 70%,#272a33 100%);
      border-radius: 12px; padding: 12px 10px 13px 15px; display: flex; align-items: center; gap: 18px;
      box-shadow: 0 2px 12px #ffd70018,0 0 0 3px #ffd70033; border:2.5px solid #ffe26830;
    }
    .history-gift { font-size: 2.45em; margin-right:6px;}
    .history-info { flex:1; }
    .history-name { font-size: 1.11em; color: #ffe79c; font-weight: 700; margin-bottom: 3px; font-family:'Russo One';}
    .history-time { font-size: .99em; color: #81e7ff;}
    .history-status { font-size: 1.02em; color: #81e278; font-weight: 900;}
    .history-status.wait { color: #ffd864;}
    .filterbar { margin: 0 0 12px 0; display: flex; gap: 9px;}
    .filter-btn { background: #262c36; border: none; color: #ffe47a; font-weight: 800; font-size: 1.01em; border-radius: 8px; padding: 7px 14px; cursor: pointer; transition:background .12s;}
    .filter-btn.active { background: #ffd700; color: #222; }
    /* -------- PROFILE -------- */
    .profile { display: flex; align-items: center; margin-bottom: 18px; gap: 16px; justify-content: center;}
    .profile-img { width: 72px; height: 72px; border-radius: 50%; object-fit: cover; border: 2.5px solid #ffe48a; background: #191c22;}
    .profile-info { text-align: left; font-size: 1.13rem; max-width: 220px; overflow: hidden; text-overflow: ellipsis;}
    .profile-info .uname { color: #ffe79c; font-family: 'Russo One', Arial, sans-serif; font-size: 1.22rem; margin-bottom: 3px; display: block;}
    .profile-id { font-size: .97em; color: #aaa; }
    /* --------- SNACKBAR/CONFETTI --------- */
    .snackbar { visibility: hidden; min-width: 180px; background: #23293b; color: #fff; text-align: center; border-radius: 12px; padding: 13px 22px;
      position: fixed; z-index: 299; left: 50%; bottom: 44px; transform: translateX(-50%); font-size: 1.12rem; box-shadow: 0 2px 14px #ffd70036;
      transition: visibility 0s, opacity .38s cubic-bezier(.4,.01,0,1), bottom .23s; opacity: 0; pointer-events: none;}
    .snackbar.show { visibility: visible; opacity: 1; pointer-events: auto; bottom: 78px;}
    .confetti { position: fixed; pointer-events: none; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 199; overflow: hidden; }
    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 8px;}
    ::-webkit-scrollbar-thumb { background: #23293b; border-radius: 4px;}
    /* Анимации */
    @keyframes fadein { from { opacity: 0;} to { opacity: 1;} }
    @keyframes tada {
      0% { transform: scale(1);}
      10%,20% { transform: scale(0.96) rotate(-6deg);}
      30%,50%,70%,90% { transform: scale(1.12) rotate(5deg);}
      40%,60%,80% { transform: scale(1.13) rotate(-7deg);}
      100% { transform: scale(1);}
    }
    @keyframes blink { 0%, 100% {opacity:1;} 40% {opacity:0.5;} }
    @keyframes modalpop { from {transform: scale(.82); opacity:0;} to {transform: scale(1); opacity:1;} }
    @keyframes emojiBounce { 0% {transform: scale(1);} 90% {transform: scale(1.19);} 100% {transform: scale(1);} }
    @keyframes giftbounce { 0% {transform: scale(1.14);} 90% {transform: scale(.93);} 100% {transform: scale(1.14);} }
    @keyframes winshine { from {opacity:.2;} to {opacity:1;} }
    @keyframes winshadow { 0% { box-shadow:0 0 0 12px #ffd70044;} 100% { box-shadow:0 0 0 6px #ffd70044;} }
    @keyframes btnpulse { 0% {box-shadow:0 3px 20px #ffd70055,0 3px 24px #0005;} 100% {box-shadow:0 3px 33px #ffd700a0,0 6px 44px #ffd70015;} }
    @media (max-width: 700px) {
      .container {max-width:99vw;}
      .item, .roulette {min-width:80px;}
      .item {min-width:80px;max-width:80px;height:112px;}
      .roulette {width:98vw;max-width:99vw;}
    }
    @media (max-width: 480px) {
      .container {padding:10px 0 0 0;}
      .profile-img { width:42px;height:42px;}
      .tabbar {max-width:100vw;}
      .item {min-width:70px;max-width:70px;height:82px;}
      .roulette {min-height:90px;max-width:100vw;}
    }
  </style>
</head>
<body>
<div id="app">
  <!-- SPLASH -->
  <div class="splash" id="splashScreen">
    <!-- Туториал 1 -->
    <div class="tutorial-step active" id="tutorialStep1">
      <div class="splash-logo">🎰</div>
      <div class="splash-title">Gift Roulette</div>
      <div class="tutorial-desc">Выигрывай уникальные Telegram-подарки в пару кликов!<br>Попробуй удачу в нашей рулетке — каждый спин честный, а подарки выдаёт бот.</div>
      <button class="tutorial-btn" id="toStep2Btn">Как забрать подарок?</button>
    </div>
    <!-- Туториал 2 -->
    <div class="tutorial-step" id="tutorialStep2">
      <div class="tutorial-ic">🧸💖</div>
      <div class="tutorial-title">Как получить выигрыш?</div>
      <div class="tutorial-desc">1. Крути рулетку.<br>2. Пиши любое сообщение <b>@MrFerra</b>.<br>3. Получай подарок прямо в Telegram!<br><br><i>Все выигрыши сохраняются в истории.</i></div>
      <button class="splash-btn" id="splashStartBtn">Начать</button>
    </div>
  </div>
  <!-- MAIN -->
  <div class="main-section" id="rouletteSection">
    <div class="container roulette-block">
      <div class="title">Gift Roulette</div>
      <div class="roulette-wrap">
        <div class="roulette" id="roulette">
          <div class="marker"></div>
          <div class="roulette-list" id="rouletteList"></div>
        </div>
      </div>
      <button class="spin-btn" id="spinBtn">Крутить бесплатно</button>
      <div class="msg" id="msgBox"></div>
      <button class="confirm-btn" id="confirmBtn">Я отправил сообщение боту</button>
      <div class="wait-status" id="waitStatus" style="display:none;">
        <span class="wait-dot">●</span> Ожидаем подтверждения от бота...
      </div>
    </div>
  </div>
  <div class="main-section" id="historySection">
    <div class="container">
      <div class="title" style="font-size:1.39em;">🏆 Мои выигрыши</div>
      <div class="filterbar">
        <button class="filter-btn active" data-filter="all">Все</button>
        <button class="filter-btn" data-filter="wait">Не получено</button>
        <button class="filter-btn" data-filter="done">Получено</button>
      </div>
      <div class="history">
        <div class="history-cards" id="historyCards"></div>
      </div>
    </div>
  </div>
  <div class="main-section" id="profileSection">
    <div class="container" style="padding-top:18px;">
      <div class="title" style="font-size:1.35em;">⚙️ Мой профиль</div>
      <div class="profile" id="profileBox" style="margin:18px auto 25px auto;display:none;">
        <img class="profile-img" id="profileImg" src="" alt="User">
        <div class="profile-info">
          <span class="uname" id="profileName"></span>
          <span class="profile-id" id="profileId"></span>
        </div>
      </div>
      <div style="font-size:.97em;color:#ffe47a;margin-top:8px;">
        Не забудь написать <b>@MrFerra</b> чтобы получить подарок!
      </div>
    </div>
  </div>
  <!-- TabBar -->
  <div class="tabbar" id="tabBar">
    <button class="tab-btn active" data-tab="rouletteSection"><span class="tab-btn-ic">🎰</span> <span>Рулетка</span></button>
    <button class="tab-btn" data-tab="historySection"><span class="tab-btn-ic">🏆</span> <span>Выигрыши</span></button>
    <button class="tab-btn" data-tab="profileSection"><span class="tab-btn-ic">⚙️</span> <span>Профиль</span></button>
  </div>
  <!-- МОДАЛ -->
  <div class="modal-bg" id="modalBg">
    <div class="modal" id="modalWindow">
      <div class="big-emoji" id="modalEmoji"></div>
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-desc" id="modalDesc"></div>
      <button class="modal-btn" id="modalBtn">Ок</button>
    </div>
  </div>
  <div class="snackbar" id="snackbar"></div>
  <canvas class="confetti" id="confetti"></canvas>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
/* ---- CONFIG ---- */
const firebaseConfig = {
  apiKey: "AIzaSyDX8BiSqlghdgOj4_zPSyPgATfHVV5DNQI",
  authDomain: "gifts-d8f30.firebaseapp.com",
  projectId: "gifts-d8f30",
  storageBucket: "gifts-d8f30.firebasestorage.app",
  messagingSenderId: "883903383261",
  appId: "1:883903383261:web:dad1742c009ea38bf5fd34",
  measurementId: "G-5JFXH4YG3J"
};
const gifts = [
  { id: 5170145012310081615, emoji: "💖", name: "Сердце" },
  { id: 5170233102089322756, emoji: "🧸", name: "Плюшевый мишка" }
];
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---- AUTH ---- */
let userId = null, userName = "", userPhoto = "";
function getTelegramUser() {
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
    const tgUser = Telegram.WebApp.initDataUnsafe.user;
    userId = tgUser.id;
    userName = (tgUser.username ? ("@" + tgUser.username) : tgUser.first_name || "User");
    userPhoto = tgUser.photo_url ? tgUser.photo_url : "https://telegram.org/img/t_logo.png";
    return tgUser;
  } else {
    showSnackbar("Откройте сайт из Telegram Mini App!");
    throw "Not in Telegram Mini App";
  }
}
const tgUser = getTelegramUser();
function saveUserOnEnter() {
  if (!userId) return;
  db.ref("users/" + userId).update({
    id: userId, name: userName, photo: userPhoto, lastVisit: new Date().toISOString()
  });
}
saveUserOnEnter();

/* ---- NAV ---- */
const tabs = ["rouletteSection","historySection","profileSection"];
function showTab(tab) {
  tabs.forEach(t=> {
    document.getElementById(t).classList.toggle('active',t===tab);
    document.querySelector('.tab-btn[data-tab="'+t+'"]').classList.toggle('active',t===tab);
  });
  if(tab==="historySection") loadHistory("all");
  if(tab==="profileSection") showProfile();
  window.scrollTo(0,0);
}
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.onclick = ()=> showTab(btn.getAttribute("data-tab"));
});

/* ---- SPLASH / TUTORIAL ---- */
const splash = document.getElementById("splashScreen");
document.getElementById("toStep2Btn").onclick = ()=>{
  document.getElementById("tutorialStep1").classList.remove("active");
  document.getElementById("tutorialStep2").classList.add("active");
}
document.getElementById("splashStartBtn").onclick = ()=>{
  splash.classList.add("hide");
  setTimeout(()=>{ splash.style.display = "none"; showTab("rouletteSection"); }, 400);
}

/* ---- SWIPE ---- */
let touchStartX = 0, touchEndX = 0;
document.getElementById('app').addEventListener('touchstart',e=>{ if(e.touches.length===1) touchStartX=e.touches[0].clientX;});
document.getElementById('app').addEventListener('touchend',e=>{
  touchEndX = e.changedTouches[0].clientX;
  let dx = touchEndX-touchStartX;
  if(Math.abs(dx)<70) return;
  let idx = tabs.findIndex(t=>document.getElementById(t).classList.contains("active"));
  if(dx<0 && idx<tabs.length-1) showTab(tabs[idx+1]);
  if(dx>0 && idx>0) showTab(tabs[idx-1]);
});

/* ---- PROFILE ---- */
function showProfile() {
  if (!userId) return;
  document.getElementById('profileImg').src = userPhoto;
  document.getElementById('profileName').textContent = userName;
  document.getElementById('profileId').textContent = "ID: " + userId;
  document.getElementById('profileBox').style.display = '';
}

/* ---- HISTORY ---- */
let allSpinsCache = [];
function loadHistory(filter="all") {
  if (!userId) return;
  db.ref("users/" + userId + "/spins").on("value", snap => {
    let arr = [];
    snap.forEach(child => {
      let v = child.val();
      v._key = child.key;
      arr.push(v);
    });
    allSpinsCache = arr.reverse();
    showHistory(filter);
  });
}
function showHistory(filter="all") {
  let arr = allSpinsCache;
  if(filter==="wait") arr = arr.filter(x=>!x.done);
  if(filter==="done") arr = arr.filter(x=>x.done);
  let el = document.getElementById('historyCards');
  if(!arr.length) { el.innerHTML='<div style="color:#ffe47a;text-align:center;padding:19px 0 14px 0;">Пока нет выигрышей</div>'; return; }
  el.innerHTML = arr.map(x=>{
    let g=gifts.find(g=>g.id==x.gift)||{emoji:"🎁",name:"Подарок"};
    return `<div class="history-card">
      <div class="history-gift">${g.emoji}</div>
      <div class="history-info">
        <div class="history-name">${g.name}</div>
        <div class="history-time">${x.time||""}</div>
        <div class="history-status ${x.done?'':'wait'}">${x.done?'Получено':'Ожидает'}</div>
      </div>
    </div>`;
  }).join('');
}
document.querySelectorAll(".filter-btn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    showHistory(btn.getAttribute("data-filter"));
  };
});

/* ---- ROULETTE ---- */
const rouletteList = document.getElementById("rouletteList");
let isSpinning = false, selectedIdx = 0;
let slots = [];
function shuffle(arr) {
  let a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function fillRoulette(selected=-1, lostIdx=[]) {
  slots = [];
  let l = 18; // оптимальная длина для физики
  let cycle = shuffle(gifts);
  let k = 0;
  for (let i=0; i<l; ++i) {
    slots.push(cycle[k]);
    k++; if (k>=cycle.length) { cycle = shuffle(gifts); k=0; }
  }
  rouletteList.innerHTML = "";
  for (let i=0; i<slots.length; ++i) {
    const gift = slots[i];
    const div = document.createElement("div");
    div.className = "item";
    if(i===selected) div.classList.add("selected","win");
    if(lostIdx.includes(i)) div.classList.add("lost");
    div.innerHTML = `<div class="gift-emoji">${gift.emoji}</div><div class="gift-name">${gift.name}</div>`;
    rouletteList.appendChild(div);
  }
}
fillRoulette();

/* ---- Реалистичная рулетка ---- */
document.getElementById("spinBtn").onclick = function() {
  if (isSpinning) return;
  isSpinning = true;
  document.getElementById('msgBox').classList.remove('visible');
  document.getElementById('confirmBtn').classList.remove('visible');
  document.getElementById('waitStatus').style.display="none";
  // Кнопка bounce
  let btn = document.getElementById("spinBtn");
  btn.style.transform = "scale(1.08)";
  setTimeout(()=>{ btn.style.transform = ""; }, 260);

  // Генерируем новую ленту
  fillRoulette();
  // Выбор выигрыша (никогда крайние индексы!)
  const winGift = gifts[Math.random()<0.5?0:1];
  let minPos = 5, maxPos = slots.length-5;
  let possible = [];
  for(let i=minPos; i<=maxPos; i++) if(slots[i].id===winGift.id) possible.push(i);
  let winPos = possible.length ? possible[Math.floor(Math.random()*possible.length)] : Math.floor((minPos+maxPos)/2);
  selectedIdx = winPos;

  // Предыдущее положение
  rouletteList.style.transition = "none";
  rouletteList.style.transform = "translateX(0)";

  // Эффект ускорения-замедления:
  setTimeout(()=> {
    let width = 108+22;
    let offset = selectedIdx*width - (rouletteList.parentNode.offsetWidth/2) + width/2;
    let duration = 2700;
    // Физика: cubic-bezier, затухание, эффект шейка
    rouletteList.style.transition = `transform ${duration/1000}s cubic-bezier(.23,1.25,.24,1)`;
    rouletteList.style.transform = `translateX(${-offset}px)`;

    // Победитель bounce + shake
    setTimeout(()=>{
      isSpinning = false;
      document.getElementById("spinBtn").disabled = false;
      // Карточка выигрыша
      for (let i=0;i<rouletteList.children.length;i++) {
        rouletteList.children[i].classList.remove('win','selected','lost');
        if(i===selectedIdx) rouletteList.children[i].classList.add('win','selected');
        else rouletteList.children[i].classList.add('lost');
      }
      // SHINE / SHAKE
      rouletteList.children[selectedIdx].style.animation += ', tada .8s';

      // Модалка
      const gift = slots[selectedIdx];
      showModal(`${gift.emoji}`, "Вы выиграли!", `<span style="font-size:1.13em;">${gift.name}</span><br>Для получения напишите <b>@MrFerra</b>.<br>Нажмите “Я отправил” после этого.`);
      // FIREBASE
      const now = new Date();
      db.ref("users/"+userId).update({
        id: userId, name: userName, photo: userPhoto, lastSpin: now.toISOString()
      });
      let newSpin = db.ref("users/"+userId+"/spins").push();
      newSpin.set({
        gift: gift.id,
        time: now.toLocaleString(),
        done: false
      });
      loadHistory("all");
      confettiEffect();
      // Сообщение и кнопка ниже
      document.getElementById('msgBox').innerHTML = `Вы выиграли <b>${gift.emoji} ${gift.name}</b>!<br>После того, как напишете <b>@MrFerra</b>, нажмите кнопку ниже.`;
      document.getElementById('msgBox').classList.add('visible');
      document.getElementById('confirmBtn').classList.add('visible');
    }, 1.03*2700);
  }, 60);
  document.getElementById("spinBtn").disabled = true;
  setTimeout(()=>{document.getElementById("spinBtn").disabled = false;}, 2950);
};

/* ---- CONFIRM ---- */
document.getElementById('confirmBtn').onclick = function() {
  if (!allSpinsCache.length) return;
  let lastSpin = allSpinsCache[0];
  db.ref(`users/${userId}/spins/${lastSpin._key}`).update({wait: true});
  document.getElementById('msgBox').innerHTML = `<span style="font-size:1.15em;">Ждём подтверждения от бота...</span>`;
  document.getElementById('confirmBtn').classList.remove('visible');
  document.getElementById('waitStatus').style.display="block";
};

/* ---- REALTIME CONFIRM ---- */
db.ref("users/"+userId+"/spins").on("child_changed", function(snap){
  let spin = snap.val();
  if(spin.done) {
    document.getElementById('waitStatus').style.display="none";
    showSnackbar("Подарок подтверждён! Поздравляем 🎉");
    loadHistory("all");
  }
});

/* ---- SNACKBAR ---- */
function showSnackbar(msg, time=2700) {
  let sb = document.getElementById('snackbar');
  sb.textContent = msg;
  sb.className = "snackbar show";
  setTimeout(()=>{ sb.className = "snackbar"; }, time);
}

/* ---- MODAL ---- */
function showModal(emoji, title, desc) {
  document.getElementById('modalEmoji').textContent = emoji;
  document.getElementById('modalTitle').innerHTML = title;
  document.getElementById('modalDesc').innerHTML = desc;
  document.getElementById('modalBg').classList.add('active');
}
document.getElementById('modalBtn').onclick = ()=>{
  document.getElementById('modalBg').classList.remove('active');
};

/* ---- CONFETTI ---- */
function confettiEffect() {
  const colors = ["#ffd700", "#ff69b4", "#00e0ca", "#ffe579", "#f68c47", "#74dbef", "#f54555"];
  const canvas = document.getElementById("confetti");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  let pieces = [];
  for (let i = 0; i < 130; i++) {
    pieces.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height * 0.1,
      w: 8 + Math.random() * 11,
      h: 17 + Math.random() * 8,
      angle: Math.random() * 2 * Math.PI,
      color: colors[Math.floor(Math.random() * colors.length)],
      vy: 2 + Math.random() * 3.6,
      vx: (Math.random() - 0.5) * 2.8,
      va: (Math.random() - 0.5) * 0.11
    });
  }
  let frames = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let p of pieces) {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.angle);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
      p.x += p.vx;
      p.y += p.vy;
      p.angle += p.va;
      if (p.y > canvas.height) p.y = -20, p.x = Math.random()*canvas.width;
    }
    frames++;
    if (frames < 100) requestAnimationFrame(draw);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  draw();
}
</script>
</body>
</html>

